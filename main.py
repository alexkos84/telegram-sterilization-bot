import os
import telebot
from telebot import types
from flask import Flask, request
from datetime import datetime
import threading

TOKEN = os.environ.get('TOKEN')
if not TOKEN:
    print("โ ะัะธะฑะบะฐ: ะะตัะตะผะตะฝะฝะฐั TOKEN ะฝะต ะฝะฐะนะดะตะฝะฐ!")
    exit(1)

PORT = int(os.environ.get('PORT', 8080))

bot = telebot.TeleBot(TOKEN)
app = Flask(__name__)

paid_text = (
    "๐ฐโจ <b>ะะะะขะะะฏ ะกะขะะะะะะะะฆะะฏ</b> โจ๐ฐ\n\n"
    "๐ <b>ะะตะบะพะผะตะฝะดัะตะผ ััะพัะฝััั ัะตะฝั ะฟัะธ ะทะฐะฟะธัะธ</b>\n"
    "๐ <b>ะะตะถะธะผ ัะฐะฑะพัั ะผะพะถะตั ัะฐะทะปะธัะฐัััั</b>\n"
    "๐ <b>ะัะฑะตัะธัะต ัะดะพะฑะฝัั ะดะปั ะฒะฐั ะบะปะธะฝะธะบั!</b>\n\n"

    "๐พ <b>ะะฒะณะตะฝะธั ะะพะฝะพะฝะตะฝะบะพ</b>\n"
    "๐ <a href='https://yandex.ru/maps/?text=ะฏะปัะฐ+ัะป.+ะะทะพะฑะธะปัะฝะฐั+20'>ัะป. ะะทะพะฑะธะปัะฝะฐั, 20</a>\n"
    "๐ +79789885105\n"
    "๐ต <b>ะกัะตัะธะปะธะทะฐัะธั ะพั 2000โฝ</b>\n\n"

    "๐พ <b>ะคะฐัะฝะฐ</b>\n"
    "๐ <a href='https://yandex.ru/maps/?text=ะฏะปัะฐ+ัะป.+ะะทะพะฑะธะปัะฝะฐั+20'>ัะป. ะะทะพะฑะธะปัะฝะฐั, 20</a>\n"
    "๐ +79789885105\n"
    "๐ต <b>ะกัะตัะธะปะธะทะฐัะธั ะพั 2300โฝ</b>\n\n"

    "๐พ <b>ะะพะบัะพั ะัะบััะฝะพะฒ</b>\n"
    "๐ <a href='https://yandex.ru/maps/?text=ะฏะปัะฐ+ัะป.+ะะพะณะพะปั+16'>ัะป. ะะพะณะพะปั, 16</a>\n"
    "๐ +79788789309\n"
    "๐ต <b>ะกัะตัะธะปะธะทะฐัะธั ะบะพัะบะธ 4500โฝ</b>\n"
    "๐ต <b>ะะฐัััะฐัะธั ะบะพัะฐ 3500โฝ</b>\n\n"

    "๐พ <b>ะะดะพัะพะฒะตะนะะพ</b>\n"
    "๐ <a href='https://yandex.ru/maps/?text=ะฏะปัะฐ+ัะป.+ะัะฐัะฝะพะฐัะผะตะนัะบะฐั+6'>ัะป. ะัะฐัะฝะพะฐัะผะตะนัะบะฐั, 6</a>\n"
    "๐ +79787824682\n"
    "๐ต <b>ะกัะตัะธะปะธะทะฐัะธั ะบะพัะบะธ 3500โฝ</b>\n"
    "๐ต <b>ะะฐัััะฐัะธั ะบะพัะฐ 2500โฝ</b>\n\n"

    "๐พ <b>ะฎะปะธั ะขะตัะตััะบ</b>\n"
    "๐ <a href='https://yandex.ru/maps/?text=ะฏะปัะฐ+ัะป.+ะะพัะบะพะฒัะบะฐั+31'>ัะป. ะะพัะบะพะฒัะบะฐั, 31</a>\n"
    "๐ +79782906405\n"
    "๐ต <b>ะกัะตัะธะปะธะทะฐัะธั ะพั 3000โฝ</b>\n\n"

    "๐พ <b>ะะนะฑะพะปะธั</b>\n"
    "๐ <a href='https://yandex.ru/maps/?text=ะฏะปัะฐ+ัะป.+ะะฐัะธะปัะตะฒะฐ+7'>ัะป. ะะฐัะธะปัะตะฒะฐ, 7</a>\n"
    "๐ +79788697009\n"
    "๐ต <b>ะกัะตัะธะปะธะทะฐัะธั ะพั 1800โฝ</b>\n\n"

    "๐พ <b>ะฏะปัะธะฝัะบะธะน ะฒะตัะตัะธะฝะฐัะฝัะน ะณะพัะฟะธัะฐะปั</b>\n"
    "๐ <a href='https://yandex.ru/maps/?text=ะฏะปัะฐ+ัะป.+ะขะธะผะธััะทะตะฒะฐ+33'>ัะป. ะขะธะผะธััะทะตะฒะฐ, 33</a>\n"
    "๐ +79787116762\n"
    "๐ต <b>ะกัะตัะธะปะธะทะฐัะธั ะพั 2000โฝ</b>\n\n"

    "๐พ <b>ะะพะฒะตัะธะต</b>\n"
    "๐ <a href='https://yandex.ru/maps/?text=ะฏะปัะฐ+ัะป.+ะฅะฐะปัััะธะฝะฐ+52ะ'>ัะป. ะฅะฐะปัััะธะฝะฐ, 52ะ</a>\n"
    "๐ +79782561501\n"
    "๐ฌ <i>ะฆะตะฝะฐ ััะพัะฝัะตััั</i>\n\n"

    "๐พ <b>ะะะฃ ะะะะฆ</b>\n"
    "๐ <a href='https://yandex.ru/maps/?text=ะฏะปัะฐ+ัะป.+ะกะพัะฐะฝั+5'>ัะป. ะกะพัะฐะฝั, 5</a>\n"
    "๐ +79788603698\n"
    "๐ฌ <i>ะฆะตะฝะฐ ััะพัะฝัะตััั</i>\n\n"
)

free_text = (
    "๐ <b>ะะะกะะะะขะะะฏ ะกะขะะะะะะะะฆะะฏ</b> ๐\n"
    "๐โโฌ <b>ะดะปั ะฑะตะทะดะพะผะฝัั ะบะพัะตะบ.</b> ๐โโฌ\n"
    "๐ฅ <b>ะ ะบะปะธะฝะธะบะต ยซะะนะฑะพะปะธัยป</b>\n"
    "๐ <a href='https://yandex.ru/maps/-/CHXZj0jJ'>ะณ. ะฏะปัะฐ, ัะป. ะะฐัะธะปัะตะฒะฐ, 7</a>\n"
    "<b>โ๏ธ ะะะะะกะฌ ะะะฏะะะขะะะฌะะ!</b>\n\n"
    "โฟโฟโฟโฟโฟโฟโฟโฟโฟโฟโฟ\n\n"
    "โผ๏ธ <b>ะะฒะพะฝะธัะต ะทะฐ 2โ3 ะดะฝั ะดะพ ะพัะปะพะฒะฐ:</b>\n"
    "โฐ <b>ะัะตะผั ะฟัะธัะผะฐ ะทะฐัะฒะพะบ: 8:00 โ 9:00</b>\n"
    "<i>(ะฒัะต ะดะฝะธ, ะบัะพะผะต ัะตัะฒะตัะณะฐ)</i>\n"
    "๐ +79781449070 <b>(ะะบะฐัะตัะธะฝะฐ)</b>\n\n"
    "โฟโฟโฟโฟโฟโฟโฟโฟโฟโฟโฟ\n\n"
    "โ๏ธ <b>ะะะะะซะ ะขะะะะะะะะะฏ:</b>\n\n"
    "โผ๏ธ <b>ะก ะะฐั ะพัะปะพะฒะธัั ะธ ะฟัะธะฒะตะทัะธ ะบะพัะบั ะฒ ะบะปะธะฝะธะบั</b>\n"
    "๐ธ <b>ะะตัะตะด ะพะฟะตัะฐัะธะตะน:</b> <u>ะะ ะบะพัะผะธัะต ะบะพัะบั</u>\n"    
    "๐ธ <b>ะะตัะตะฝะพัะบะฐ:</b> ัะพะปัะบะพ ะฟะปะฐััะธะบะพะฒะฐั ะธ ะฟัะพัะฝะฐั\n"
    "   <i>(ะฟัะธ ัะพะผะฝะตะฝะธัั โ ะฟะตัะตะผะพัะฐะนัะต ัะบะพััะตะผ!)</i>\n"
    "๐ธ <b>ะะฝัััะธ:</b> ะพะฑัะทะฐัะตะปัะฝะพ ะฟะพะปะพะถะธัะต ะฟะตะปัะฝะบั\n"
    "๐ธ <b>ะะฐ ะฟะตัะตะฝะพัะบั:</b> ะฟัะธะบะปะตะนัะต ะทะฐะฟะธัะบั ั ะฐะดัะตัะพะผ\n"
    "   ะธ ะฒะฐัะธะผ ะฝะพะผะตัะพะผ ัะตะปะตัะพะฝะฐ\n"
    "๐ <b>ะะพะถะตัะต ะฟะพะปะพะถะธัั ะผัะณะบะธะน ะบะพัะผ ะฒ ะฟะฐะบะตัะธะบะฐั</b>\n"
    "๐ซ <b><u>ะขะบะฐะฝะตะฒัะต ะฟะตัะตะฝะพัะบะธ ะธ ััะผะบะธ ะะะะะะฉะะะซ!</u></b>\n\n"
    "โฟโฟโฟโฟโฟโฟโฟโฟโฟโฟโฟ\n\n"
    "๐ก๏ธ <b>ะะะกะะ ะกะขะะะะะะะะฆะะ:</b>\n\n"
    "โ <b>ะะพัะบั ะทะฐะฑะธัะฐัั ะฝะฐัะธ ะฒะพะปะพะฝัััั</b>\n"
    "โ <b>ะะตัะตะดะตัะถะบะฐ 1โ2 ะดะฝั ะดะปั ะฒะพัััะฐะฝะพะฒะปะตะฝะธั</b>\n"
    "โ <b>ะะพะทะฒัะฐั ะฟะพ ัะบะฐะทะฐะฝะฝะพะผั ะะฐะผะธ ะฐะดัะตัั</b>\n\n"
    "โฟโฟโฟโฟโฟโฟโฟโฟโฟโฟโฟ\n\n"
    "๐ข <b>ะะะฃะะฌะฏ, ะะ ะฃะะฃะกะขะะขะ ะจะะะก!</b>\n\n"
    "๐พ <b>ะะพะปะธัะตััะฒะพ ะผะตัั ะะะะะะะงะะะ</b>\n"
    "โ๏ธ <b>ะะฒะพะฝะธัะต ะธ ะทะฐะฟะธััะฒะฐะนัะตัั ะฟััะผะพ ัะตะนัะฐั!</b>\n\n"
    "๐๐ฑ <b><i>ะะผะตััะต ะผั ะดะตะปะฐะตะผ ะผะธั ะดะพะฑัะตะต!</i></b> ๐ฑ๐"
)

@app.route('/')
def home():
    return f"๐ค Bot is running! Time: {datetime.now().strftime('%H:%M:%S')}"

@app.route('/health')
def health():
    return {"status": "ok", "time": datetime.now().isoformat()}

@bot.message_handler(commands=['start'])
def start(message):
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    markup.add("๐ฐ ะะปะฐัะฝะฐั", "๐ ะะตัะฟะปะฐัะฝะฐั")
    bot.send_message(message.chat.id, "ะัะฑะตัะธัะต ัะธะฟ ััะตัะธะปะธะทะฐัะธะธ:", reply_markup=markup)

@bot.message_handler(commands=['status'])
def status(message):
    current_time = datetime.now().strftime('%d.%m.%Y %H:%M:%S')
    bot.send_message(message.chat.id, f"๐ค ะะพั ัะฐะฑะพัะฐะตั!\nโฐ ะัะตะผั: {current_time}")

@bot.message_handler(func=lambda message: True)
def handle_buttons(message):
    if message.text == "๐ฐ ะะปะฐัะฝะฐั":
        bot.send_message(message.chat.id, paid_text, parse_mode="HTML", disable_web_page_preview=True)
    elif message.text == "๐ ะะตัะฟะปะฐัะฝะฐั":
        bot.send_message(message.chat.id, free_text, parse_mode="HTML", disable_web_page_preview=True)
    else:
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
        markup.add("๐ฐ ะะปะฐัะฝะฐั", "๐ ะะตัะฟะปะฐัะฝะฐั")
        bot.send_message(message.chat.id, "ะะพะถะฐะปัะนััะฐ, ะฒัะฑะตัะธัะต ะพะดะฝั ะธะท ะบะฝะพะฟะพะบ ะฝะธะถะต:", reply_markup=markup)

def run_bot():
    print("๐ Starting Telegram bot...")
    bot.polling(none_stop=True, interval=1)

if __name__ == "__main__":
    # ะะฐะฟััะบะฐะตะผ ะฑะพัะฐ ะฒ ะพัะดะตะปัะฝะพะผ ะฟะพัะพะบะต
    bot_thread = threading.Thread(target=run_bot, daemon=True)
    bot_thread.start()
    
    # ะะฐะฟััะบะฐะตะผ Flask ะดะปั health checks
    print(f"๐ Starting Flask on port {PORT}")
    app.run(host='0.0.0.0', port=PORT)
