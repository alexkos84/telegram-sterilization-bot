import os
import telebot
from telebot import types
from flask import Flask, request, jsonify
from datetime import datetime
import time
import logging
import json
import requests
from bs4 import BeautifulSoup
import re
from typing import Dict, List, Optional

# ğŸ”§ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

class AdvancedChannelParser:
    """ĞŸĞ°Ñ€ÑĞµÑ€ Ğ³Ñ€ÑƒĞ¿Ğ¿ Ğ¸ ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ² Ğ¾ Ğ¶Ğ¸Ğ²Ğ¾Ñ‚Ğ½Ñ‹Ñ… Ğ² Ğ¯Ğ»Ñ‚Ğµ"""
    
    def __init__(self):
        self.channels = [
            {
                'username': 'cats_yalta',
                'url': 'https://t.me/cats_yalta',
                'type': 'cats',
                'title': 'ĞšĞ¾Ñ‚Ğ¸ĞºĞ¸ Ğ¯Ğ»Ñ‚Ğ° (ĞºĞ°Ğ½Ğ°Ğ»)'
            },
            {
                'username': 'cats_yalta_group',
                'url': 'https://t.me/cats_yalta_group',
                'type': 'cats',
                'title': 'ĞšĞ¾Ñ‚Ğ¸ĞºĞ¸ Ğ¯Ğ»Ñ‚Ğ° (Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ°)'
            }
        ]
        self.posts_cache = []
        self.last_update = None
    
    def get_channel_posts(self, channel_type: str = 'all', limit: int = 5) -> List[Dict]:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ Ğ¿Ğ¾ÑÑ‚Ñ‹ Ñ Ñ„Ğ¾Ñ‚Ğ¾ Ğ¸Ğ· Ğ²ÑĞµÑ… ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ²"""
        try:
            posts = []
            for channel in self.channels:
                if channel_type != 'all' and channel['type'] != channel_type:
                    continue
                    
                web_url = f'https://t.me/s/{channel["username"]}'
                logger.info(f"ğŸŒ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ² Ñ {web_url}")
                response = requests.get(web_url, headers={
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
                }, timeout=15)
                response.raise_for_status()
                
                soup = BeautifulSoup(response.content, 'html.parser')
                message_divs = soup.find_all('div', class_='tgme_widget_message')
                
                for div in message_divs[:limit*2]:
                    post_data = self.parse_message_div(div, channel)
                    if post_data and self.is_animal_related(post_data.get('text', '')):
                        posts.append(post_data)
                        if len(posts) >= limit:
                            break
            
            # Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾ Ğ´Ğ°Ñ‚Ğµ (Ğ½Ğ¾Ğ²Ñ‹Ğµ ÑĞ½Ğ°Ñ‡Ğ°Ğ»Ğ°)
            posts.sort(key=lambda x: x.get('timestamp', 0), reverse=True)
            
            if posts:
                self.posts_cache = posts[:limit]
                self.last_update = datetime.now()
                logger.info(f"âœ… ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¾ {len(posts)} Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ² (Ñ Ñ„Ğ¾Ñ‚Ğ¾: {sum(1 for p in posts if p['photo_url'])})")
            else:
                logger.warning("âš ï¸ ĞĞµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´ÑÑ‰Ğ¸Ñ… Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ²")
                
            return posts[:limit] or self.get_mock_posts(channel_type)
            
        except Exception as e:
            logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ°Ñ€ÑĞ¸Ğ½Ğ³Ğ°: {e}")
            return self.get_mock_posts(channel_type)
    
    def parse_message_div(self, div, channel) -> Optional[Dict]:
        """ĞŸĞ°Ñ€ÑĞ¸Ñ‚ Ğ¿Ğ¾ÑÑ‚, Ğ¸Ğ·Ğ²Ğ»ĞµĞºĞ°Ñ Ñ‚ĞµĞºÑÑ‚ Ğ¸ Ñ„Ğ¾Ñ‚Ğ¾"""
        try:
            # Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
            post_id = div.get('data-post', '').split('/')[-1] or 'unknown'
            text_div = div.find('div', class_='tgme_widget_message_text')
            text = text_div.get_text(strip=True) if text_div else ""
            
            # Ğ”Ğ°Ñ‚Ğ°
            timestamp = 0
            date_elem = div.find('time', datetime=True)
            date_str = "ĞĞµĞ´Ğ°Ğ²Ğ½Ğ¾"
            if date_elem:
                try:
                    dt = datetime.fromisoformat(date_elem['datetime'].replace('Z', '+00:00'))
                    date_str = dt.strftime('%d.%m.%Y %H:%M')
                    timestamp = dt.timestamp()
                except:
                    pass
            
            # Ğ¤Ğ¾Ñ‚Ğ¾ (Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğµ Ğ¿Ñ€ĞµĞ²ÑŒÑ)
            photo_url = None
            photo_wrap = div.find('a', class_='tgme_widget_message_photo_wrap')
            if photo_wrap and photo_wrap.get('style'):
                match = re.search(r"background-image:url\('(.*?)'\)", photo_wrap['style'])
                if match:
                    photo_url = match.group(1)
            
            # Ğ’Ğ¸Ğ´ĞµĞ¾
            video_url = None
            video_wrap = div.find('div', class_='tgme_widget_message_video_wrap')
            if video_wrap and video_wrap.get('style'):
                match = re.search(r"background-image:url\('(.*?)'\)", video_wrap['style'])
                if match:
                    video_url = match.group(1)
            
            if not text and not photo_url and not video_url:
                return None
            
            return {
                'id': post_id,
                'text': text,
                'date': date_str,
                'timestamp': timestamp,
                'url': f"{channel['url']}/{post_id}" if post_id else channel['url'],
                'title': self.extract_title(text),
                'description': self.extract_description(text),
                'contact': self.extract_contact(text),
                'photo_url': photo_url,
                'video_url': video_url,
                'has_media': bool(photo_url or video_url),
                'type': channel['type'],
                'channel': channel['title'],
                'channel_url': channel['url']
            }
            
        except Exception as e:
            logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ°Ñ€ÑĞ¸Ğ½Ğ³Ğ° div: {e}")
            return None
    
    def extract_title(self, text: str) -> str:
        """Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµÑ‚ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº Ğ¸Ğ· Ñ‚ĞµĞºÑÑ‚Ğ° Ğ¿Ğ¾ÑÑ‚Ğ°"""
        lines = text.split('\n')
        for line in lines[:3]:
            line = line.strip()
            if line and len(line) > 5:
                title = re.sub(r'[^\w\s\-\.,!?Ğ°-ÑÑ‘Ğ-Ğ¯Ğ]', '', line)
                if len(title) > 50:
                    title = title[:50] + "..."
                return title or "ĞšĞ¾Ñ‚Ğ¸Ğº Ğ¸Ñ‰ĞµÑ‚ Ğ´Ğ¾Ğ¼"
        return "ĞšĞ¾Ñ‚Ğ¸Ğº Ğ¸Ñ‰ĞµÑ‚ Ğ´Ğ¾Ğ¼"
    
    def extract_description(self, text: str) -> str:
        """Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµÑ‚ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¸Ğ· Ñ‚ĞµĞºÑÑ‚Ğ°"""
        clean_text = re.sub(r'@\w+|https?://\S+|\+?\d[\d\s\-\(\)]+', '', text)
        clean_text = re.sub(r'\s+', ' ', clean_text).strip()
        if len(clean_text) > 200:
            return clean_text[:200] + "..."
        return clean_text or "ĞŸĞ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ² Ğ¿Ğ¾ÑÑ‚Ğµ"
    
    def extract_contact(self, text: str) -> str:
        """Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµÑ‚ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ½ÑƒÑ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ"""
        phone_pattern = r'\+?[78][\s\-]?\(?9\d{2}\)?\s?[\d\s\-]{7,10}'
        phones = re.findall(phone_pattern, text)
        
        username_pattern = r'@\w+'
        usernames = re.findall(username_pattern, text)
        
        contacts = []
        if phones:
            contacts.extend(phones[:1])
        if usernames:
            contacts.extend(usernames[:1])
            
        return ' â€¢ '.join(contacts) if contacts else "Ğ¡Ğ¼. Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿Ğµ"
    
    def is_animal_related(self, text: str) -> bool:
        """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, Ğ¾Ñ‚Ğ½Ğ¾ÑĞ¸Ñ‚ÑÑ Ğ»Ğ¸ Ğ¿Ğ¾ÑÑ‚ Ğº Ğ¶Ğ¸Ğ²Ğ¾Ñ‚Ğ½Ñ‹Ğ¼"""
        animal_keywords = [
            'ĞºĞ¾Ñ‚', 'ĞºĞ¾ÑˆĞº', 'ĞºĞ¾Ñ‚ĞµĞ½', 'ĞºĞ¾Ñ‚Ğ¸Ğº', 'Ğ¼ÑƒÑ€Ğ·', 'Ğ¼ÑÑƒ',
            'Ğ¿Ñ€Ğ¸ÑÑ‚Ñ€Ğ¾Ğ¹', 'Ğ´Ğ¾Ğ¼', 'Ğ¿Ğ¸Ñ‚Ğ¾Ğ¼ĞµÑ†', 'ÑÑ‚ĞµÑ€Ğ¸Ğ»', 'Ğ¿Ñ€Ğ¸Ğ²Ğ¸Ğ²Ğº',
            'Ğ¿Ğ¾Ñ‚ĞµÑ€ÑĞ»', 'Ğ½Ğ°ÑˆĞµĞ»', 'Ğ¿Ñ€Ğ¾Ğ¿Ğ°Ğ»', 'Ğ½Ğ°Ğ¹Ğ´ĞµĞ½', 'Ğ¿Ğ¾Ñ‚ĞµÑ€ÑÑˆĞºĞ°'
        ]
        text_lower = text.lower()
        return any(keyword in text_lower for keyword in animal_keywords)
    
    def get_mock_posts(self, channel_type: str = 'cats') -> List[Dict]:
        """Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğµ Ğ¿Ğ¾ÑÑ‚Ñ‹ Ñ Ñ„Ğ¾Ñ‚Ğ¾"""
        return [
            {
                'id': '1001',
                'title': 'ğŸ± ĞšĞ¾Ñ‚ĞµĞ½Ğ¾Ğº ĞœÑƒÑ€Ğ·Ğ¸Ğº Ğ¸Ñ‰ĞµÑ‚ Ğ´Ğ¾Ğ¼',
                'description': 'Ğ’Ğ¾Ğ·Ñ€Ğ°ÑÑ‚: 2 Ğ¼ĞµÑÑÑ†Ğ°, Ğ¼Ğ°Ğ»ÑŒÑ‡Ğ¸Ğº, Ñ€Ñ‹Ğ¶Ğ¸Ğ¹ Ğ¾ĞºÑ€Ğ°Ñ. Ğ—Ğ´Ğ¾Ñ€Ğ¾Ğ², Ğ¿Ñ€Ğ¸Ğ²Ğ¸Ñ‚, Ğ¾Ñ‡ĞµĞ½ÑŒ Ğ¸Ğ³Ñ€Ğ¸Ğ²Ñ‹Ğ¹.',
                'date': '03.08.2025 14:30',
                'timestamp': time.time(),
                'url': 'https://t.me/cats_yalta/1001',
                'contact': '@volunteer1 â€¢ +7 978 123-45-67',
                'photo_url': 'https://via.placeholder.com/600x400?text=ĞšĞ¾Ñ‚ĞµĞ½Ğ¾Ğº+ĞœÑƒÑ€Ğ·Ğ¸Ğº',
                'video_url': None,
                'has_media': True,
                'type': 'cats',
                'channel': 'ĞšĞ¾Ñ‚Ğ¸ĞºĞ¸ Ğ¯Ğ»Ñ‚Ğ°',
                'channel_url': 'https://t.me/cats_yalta'
            },
            {
                'id': '1002',
                'title': 'ğŸ± Ğ’Ğ·Ñ€Ğ¾ÑĞ»Ñ‹Ğ¹ ĞºĞ¾Ñ‚ Ğ‘Ğ°Ñ€ÑĞ¸Ğº',
                'description': 'Ğ˜Ñ‰ĞµÑ‚ Ğ´Ğ¾Ğ¼ Ğ²Ğ·Ñ€Ğ¾ÑĞ»Ñ‹Ğ¹ ĞºĞ¾Ñ‚, 3 Ğ³Ğ¾Ğ´Ğ°, ĞºĞ°ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½, Ğ¿Ñ€Ğ¸ÑƒÑ‡ĞµĞ½ Ğº Ğ»Ğ¾Ñ‚ĞºÑƒ.',
                'date': '02.08.2025 11:20',
                'timestamp': time.time() - 3600,
                'url': 'https://t.me/cats_yalta_group/1002',
                'contact': '+7 978 765-43-21',
                'photo_url': 'https://via.placeholder.com/600x400?text=ĞšĞ¾Ñ‚+Ğ‘Ğ°Ñ€ÑĞ¸Ğº',
                'video_url': None,
                'has_media': True,
                'type': 'cats',
                'channel': 'ĞšĞ¾Ñ‚Ğ¸ĞºĞ¸ Ğ¯Ğ»Ñ‚Ğ° (Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ°)',
                'channel_url': 'https://t.me/cats_yalta_group'
            }
        ]
    
    def get_cached_posts(self, channel_type: str = 'all') -> List[Dict]:
        """Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ»Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾ÑÑ‚Ñ‹"""
        if (not self.last_update or 
            (datetime.now() - self.last_update).seconds > 3600):  # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ñ‡Ğ°Ñ
            try:
                return self.get_channel_posts(channel_type)
            except:
                pass
        return [p for p in self.posts_cache if channel_type == 'all' or p['type'] == channel_type] or self.get_mock_posts(channel_type)

class CatBotWithPhotos:
    """Ğ‘Ğ¾Ñ‚ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ¸ ĞºĞ¾ÑˆĞºĞ°Ğ¼ Ğ¯Ğ»Ñ‚Ñ‹ Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¾Ğ¹ Ñ„Ğ¾Ñ‚Ğ¾ Ğ¸ Ğ²Ğ¸Ğ´ĞµĞ¾"""
    
    def __init__(self):
        self.token = os.environ.get('TOKEN')
        if not self.token:
            logger.error("âŒ TOKEN Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½!")
            exit(1)
        
        self.bot = telebot.TeleBot(self.token)
        self.parser = AdvancedChannelParser()
        self.app = Flask(__name__)
        self.port = int(os.environ.get('PORT', 8080))
        self.webhook_url = os.environ.get('WEBHOOK_URL')
        self.stats = {"users": set(), "messages": 0}
        
        self.setup_handlers()
        self.setup_routes()
    
    def send_post(self, chat_id: int, post: Dict):
        """ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ¾Ğ´Ğ¸Ğ½ Ğ¿Ğ¾ÑÑ‚ Ñ Ğ¼ĞµĞ´Ğ¸Ğ° Ğ¸Ğ»Ğ¸ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼"""
        try:
            emoji = 'ğŸ±' if post['type'] == 'cats' else 'ğŸ¶'
            post_text = (
                f"{emoji} <b>{post['title']}</b>\n\n"
                f"{post['description']}\n\n"
                f"ğŸ“… {post['date']}\n"
                f"ğŸ“ {post['contact']}\n"
                f"ğŸ“¢ <a href='{post['channel_url']}'>{post['channel']}</a>\n"
                f"ğŸ”— <a href='{post['url']}'>ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¿Ğ¾ÑÑ‚</a>"
            )
            
            if len(post_text) > 1024:
                post_text = post_text[:1000] + "..."
            
            # ĞŸÑ‹Ñ‚Ğ°ĞµĞ¼ÑÑ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¼ĞµĞ´Ğ¸Ğ°
            if post.get('photo_url'):
                try:
                    self.bot.send_photo(
                        chat_id,
                        post['photo_url'],
                        caption=post_text,
                        parse_mode="HTML",
                        reply_markup=types.InlineKeyboardMarkup().add(
                            types.InlineKeyboardButton("ğŸ“¢ ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¿Ğ¾ÑÑ‚", url=post['url'])
                        )
                    )
                    return
                except Exception as e:
                    logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ñ„Ğ¾Ñ‚Ğ¾: {e}")
            
            if post.get('video_url'):
                try:
                    self.bot.send_video(
                        chat_id,
                        post['video_url'],
                        caption=post_text,
                        parse_mode="HTML",
                        reply_markup=types.InlineKeyboardMarkup().add(
                            types.InlineKeyboardButton("ğŸ“¢ ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¿Ğ¾ÑÑ‚", url=post['url'])
                        )
                    )
                    return
                except Exception as e:
                    logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ²Ğ¸Ğ´ĞµĞ¾: {e}")
            
            # Ğ•ÑĞ»Ğ¸ Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¼ĞµĞ´Ğ¸Ğ°, Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ‚ĞµĞºÑÑ‚
            self.bot.send_message(
                chat_id,
                post_text,
                parse_mode="HTML",
                disable_web_page_preview=False,
                reply_markup=types.InlineKeyboardMarkup().add(
                    types.InlineKeyboardButton("ğŸ“¢ ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¿Ğ¾ÑÑ‚", url=post['url'])
                )
            )
            
        except Exception as e:
            logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ¿Ğ¾ÑÑ‚Ğ°: {e}")

    def send_channel_posts(self, chat_id: int, animal_type: str = 'cats'):
        """ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ²ÑĞµ Ğ¿Ğ¾ÑÑ‚Ñ‹ Ñ Ğ¼ĞµĞ´Ğ¸Ğ°"""
        try:
            posts = self.parser.get_cached_posts(animal_type)
            
            if not posts:
                self.bot.send_message(
                    chat_id,
                    "ğŸ˜¿ Ğ¡ĞµĞ¹Ñ‡Ğ°Ñ Ğ½ĞµÑ‚ Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ¾Ğ±ÑŠÑĞ²Ğ»ĞµĞ½Ğ¸Ğ¹.\n"
                    f"ğŸ“¢ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹:\n"
                    f"â€¢ {self.parser.channels[0]['url']}\n"
                    f"â€¢ {self.parser.channels[1]['url']}"
                )
                return
            
            self.bot.send_message(
                chat_id,
                f"ğŸ± <b>ĞšĞĞ¢Ğ˜ĞšĞ˜ Ğ˜Ğ©Ğ£Ğ¢ Ğ”ĞĞœ</b>\n\n"
                f"ğŸ“¢ ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ Ğ¾Ğ±ÑŠÑĞ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¸Ğ· Ğ³Ñ€ÑƒĞ¿Ğ¿ Ğ¯Ğ»Ñ‚Ñ‹:",
                parse_mode="HTML"
            )
            
            for post in posts:
                self.send_post(chat_id, post)
                time.sleep(0.7)  # Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ Ñ„Ğ»ÑƒĞ´Ğ°
            
            self.bot.send_message(
                chat_id,
                "ğŸ’¡ <b>ĞšĞ°Ğº Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ?</b>\n\n"
                f"ğŸ  <b>Ğ’Ğ·ÑÑ‚ÑŒ ĞºĞ¾Ñ‚Ğ¸ĞºĞ°:</b>\nĞ¡Ğ²ÑĞ¶Ğ¸Ñ‚ĞµÑÑŒ Ğ¿Ğ¾ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ°Ğ¼ Ğ¸Ğ· Ğ¾Ğ±ÑŠÑĞ²Ğ»ĞµĞ½Ğ¸Ñ\n\n"
                f"ğŸ“¢ <b>Ğ“Ñ€ÑƒĞ¿Ğ¿Ñ‹:</b>\n"
                f"â€¢ <a href='{self.parser.channels[0]['url']}'>ĞšĞ¾Ñ‚Ğ¸ĞºĞ¸ Ğ¯Ğ»Ñ‚Ğ° (ĞºĞ°Ğ½Ğ°Ğ»)</a>\n"
                f"â€¢ <a href='{self.parser.channels[1]['url']}'>ĞšĞ¾Ñ‚Ğ¸ĞºĞ¸ Ğ¯Ğ»Ñ‚Ğ° (Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ°)</a>\n\n"
                "ğŸ¤ <b>Ğ¡Ñ‚Ğ°Ñ‚ÑŒ Ğ²Ğ¾Ğ»Ğ¾Ğ½Ñ‚ĞµÑ€Ğ¾Ğ¼:</b>\nĞĞ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿Ñƒ",
                parse_mode="HTML"
            )
            
        except Exception as e:
            logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ²: {e}")
            self.bot.send_message(
                chat_id,
                f"âš ï¸ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ¾Ğ±ÑŠÑĞ²Ğ»ĞµĞ½Ğ¸Ğ¹\n\n"
                f"ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ·Ğ¶Ğµ Ğ¸Ğ»Ğ¸ Ğ¿Ğ¾ÑĞµÑ‚Ğ¸Ñ‚Ğµ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹:\n"
                f"â€¢ {self.parser.channels[0]['url']}\n"
                f"â€¢ {self.parser.channels[1]['url']}"
            )

    def get_main_keyboard(self):
        """Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ°"""
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=2)
        markup.add("ğŸ¥ Ğ¡Ñ‚ĞµÑ€Ğ¸Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ", "ğŸ  ĞŸÑ€Ğ¸ÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ¾")
        markup.add("ğŸ“ ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹", "â„¹ï¸ Ğ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğµ")
        markup.add("ğŸ± ĞĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ğ¾ÑÑ‚Ñ‹")
        return markup
    
    def get_adoption_keyboard(self):
        """ĞšĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ° Ğ¿Ñ€Ğ¸ÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ°"""
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
        markup.add("ğŸ± ĞšĞ¾ÑˆĞºĞ¸ Ğ¸Ñ‰ÑƒÑ‚ Ğ´Ğ¾Ğ¼")
        markup.add("ğŸ“ ĞŸĞ¾Ğ´Ğ°Ñ‚ÑŒ Ğ¾Ğ±ÑŠÑĞ²Ğ»ĞµĞ½Ğ¸Ğµ")
        markup.add("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´")
        return markup
    
    def get_sterilization_keyboard(self):
        """ĞšĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ° ÑÑ‚ĞµÑ€Ğ¸Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸"""
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
        markup.add("ğŸ’° ĞŸĞ»Ğ°Ñ‚Ğ½Ğ°Ñ ÑÑ‚ĞµÑ€Ğ¸Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ", "ğŸ†“ Ğ‘ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ğ°Ñ ÑÑ‚ĞµÑ€Ğ¸Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ")
        markup.add("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´")
        return markup

    def get_contacts_keyboard(self):
        """ĞšĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ° ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ¾Ğ²"""
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
        markup.add("ğŸ¥ ĞšĞ»Ğ¸Ğ½Ğ¸ĞºĞ¸", "ğŸ¤ Ğ’Ğ¾Ğ»Ğ¾Ğ½Ñ‚ĞµÑ€Ñ‹")
        markup.add("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´")
        return markup
    
    def get_clinics_keyboard(self):
        """ĞšĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ° Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ğ³Ğ¾Ñ€Ğ¾Ğ´Ğ¾Ğ² Ğ´Ğ»Ñ ĞºĞ»Ğ¸Ğ½Ğ¸Ğº"""
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=2)
        markup.add("ğŸ›ï¸ Ğ¯Ğ»Ñ‚Ğ°", "ğŸŒŠ Ğ“ÑƒÑ€Ğ·ÑƒÑ„")
        markup.add("ğŸ”ï¸ Ğ“Ğ°ÑĞ¿Ñ€Ğ°", "ğŸŒ… ĞšĞ¾Ñ€ĞµĞ¸Ğ·")
        markup.add("ğŸ–ï¸ ĞĞ»ÑƒĞ¿ĞºĞ°", "ğŸŒ² Ğ¡Ğ¸Ğ¼ĞµĞ¸Ğ·")
        markup.add("â›°ï¸ ĞĞ¿Ğ¾Ğ»Ğ·Ğ½ĞµĞ²Ğ¾Ğµ")
        markup.add("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´")
        return markup

    def load_html_file(self, filename: str) -> str:
        """Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµÑ‚ HTML Ñ„Ğ°Ğ¹Ğ» Ğ¸Ğ· Ğ¿Ğ°Ğ¿ĞºĞ¸ assets"""
        try:
            with open(f'assets/{filename}', 'r', encoding='utf-8') as f:
                return f.read()
        except Exception as e:
            logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ HTML: {e}")
            return f"âš ï¸ Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ° ({filename})"

    def send_long_message(self, chat_id: int, text: str, parse_mode="HTML"):
        """ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ´Ğ»Ğ¸Ğ½Ğ½Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ, Ñ€Ğ°Ğ·Ğ±Ğ¸Ğ²Ğ°Ñ Ğ½Ğ° Ñ‡Ğ°ÑÑ‚Ğ¸ ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾"""
        max_length = 4000  # ĞÑÑ‚Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ·Ğ°Ğ¿Ğ°Ñ Ğ´Ğ»Ñ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¼Ğ°Ñ€ĞºĞµÑ€Ğ° Ñ€Ğ°Ğ·Ğ´ĞµĞ»ĞµĞ½Ğ¸Ñ
        if "---SPLIT---" in text:
            parts = text.split("---SPLIT---")
            for i, part in enumerate(parts):
                if i > 0:
                    time.sleep(0.5)  # Ğ—Ğ°Ğ´ĞµÑ€Ğ¶ĞºĞ° Ğ¼ĞµĞ¶Ğ´Ñƒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸ÑĞ¼Ğ¸
                part = part.strip()
                if part:
                    self.bot.send_message(chat_id, part, parse_mode=parse_mode)
            return
        
        if len(text) <= max_length:
            self.bot.send_message(chat_id, text, parse_mode=parse_mode)
            return
        
        # Ğ Ğ°Ğ·Ğ±Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¿Ğ¾ ÑÑ‚Ñ€Ğ¾ĞºĞ°Ğ¼
        parts = []
        current_part = ""
        
        lines = text.split('\n')
        for line in lines:
            test_part = current_part + '\n' + line if current_part else line
            
            if len(test_part) > max_length and current_part:
                parts.append(current_part.strip())
                current_part = line
            else:
                current_part = test_part
        
        if current_part:
            parts.append(current_part.strip())
        
        # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ‡Ğ°ÑÑ‚Ğ¸ Ñ Ğ½ĞµĞ±Ğ¾Ğ»ÑŒÑˆĞ¾Ğ¹ Ğ·Ğ°Ğ´ĞµÑ€Ğ¶ĞºĞ¾Ğ¹
        for i, part in enumerate(parts):
            if i > 0:
                time.sleep(0.5)  # Ğ—Ğ°Ğ´ĞµÑ€Ğ¶ĞºĞ° Ğ¼ĞµĞ¶Ğ´Ñƒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸ÑĞ¼Ğ¸
            if part.strip():
                self.bot.send_message(chat_id, part, parse_mode=parse_mode)
    
    def get_clinics_by_city(self, city: str) -> str:
        """Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑĞ¿Ğ¸ÑĞ¾Ğº ĞºĞ»Ğ¸Ğ½Ğ¸Ğº Ğ¿Ğ¾ Ğ³Ğ¾Ñ€Ğ¾Ğ´Ñƒ"""
        clinics_data = {
        clinics_data = {
            "ÑĞ»Ñ‚Ğ°": """<b>ğŸ“ Ğ¯Ğ›Ğ¢Ğ</b>

1ï¸âƒ£ <b>ĞšĞ»Ğ¸Ğ½Ğ¸ĞºĞ° "ĞĞ¹Ğ±Ğ¾Ğ»Ğ¸Ñ‚"</b>
ğŸ“Œ ÑƒĞ». Ğ’Ğ°ÑĞ¸Ğ»ÑŒĞµĞ²Ğ°-Ğ¢Ñ€ĞµĞ½Ñ‘Ğ²Ğ°, 3/7
ğŸ•’ ĞŸĞ½â€“ĞŸÑ‚: 9:00â€“19:00; Ğ¡Ğ±â€“Ğ’Ñ: 9:00â€“17:00
ğŸ’Š Ğ’ĞµÑ‚Ğ°Ğ¿Ñ‚ĞµĞºĞ°: +7 (978) 869-73-80
ğŸ‘¨â€âš•ï¸ Ğ’Ñ€Ğ°Ñ‡Ğ¸: Ğ Ğ¾Ğ¼Ğ°Ğ½ Ğ›ĞµĞ¾Ğ½Ğ¸Ğ´Ğ¾Ğ²Ğ¸Ñ‡ +7 (978) 761-66-52, ĞĞ°Ñ‚Ğ°Ğ»ÑŒÑ Ğ“ĞµĞ¾Ñ€Ğ³Ğ¸ĞµĞ²Ğ½Ğ° +7 (978) 869-70-09, +7 (978) 761-65-79
ğŸš« ĞĞ° Ğ´Ğ¾Ğ¼ Ğ½Ğµ Ğ²Ñ‹ĞµĞ·Ğ¶Ğ°ÑÑ‚
ğŸ”— <a href="https://vk.com/zoovet1">VK ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ°</a>

2ï¸âƒ£ <b>Ğ—Ğ¾Ğ¾Ğ²ĞµÑ‚Ñ†ĞµĞ½Ñ‚Ñ€ "Ğ—Ğ´Ğ¾Ñ€Ğ¾Ğ²ĞµĞ¹ĞšĞ¾"</b>
ğŸ“Œ ÑƒĞ». ĞšÑ€Ğ°ÑĞ½Ğ¾Ğ°Ñ€Ğ¼ĞµĞ¹ÑĞºĞ°Ñ, 6
ğŸ•’ ĞŸĞ½â€“ĞŸÑ‚: 9:00â€“17:00
ğŸš« Ğ¡Ğ±â€“Ğ’Ñ: Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹
ğŸ’Š Ğ•ÑÑ‚ÑŒ Ğ²ĞµÑ‚Ğ°Ğ¿Ñ‚ĞµĞºĞ°
ğŸ  Ğ’Ñ‹ĞµĞ·Ğ´ Ğ½Ğ° Ğ´Ğ¾Ğ¼: 1500 Ñ€ÑƒĞ±.
ğŸ‘©â€âš•ï¸ Ğ®Ğ»Ğ¸Ñ Ğ’Ğ¸ĞºÑ‚Ğ¾Ñ€Ğ¾Ğ²Ğ½Ğ°: +7 (978) 782-46-81, +7 (978) 782-46-82
ğŸ”— <a href="https://vk.com/vet.zdoroveyko">VK ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ°</a>

3ï¸âƒ£ <b>Ğ¯Ğ»Ñ‚Ğ¸Ğ½ÑĞºĞ¸Ğ¹ Ğ—ĞĞĞ¦Ğ•ĞĞ¢Ğ </b>
ğŸ“Œ ÑƒĞ». ĞœĞ¾ÑĞºĞ¾Ğ²ÑĞºĞ°Ñ, 33Ğ‘ (Ñ‚ĞµÑ€Ñ€Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ Ğ¡Ğ¢Ğ)
ğŸ•’ ĞŸĞ½â€“ĞŸÑ‚: 9:30â€“19:00; Ğ¡Ğ±: 9:30â€“14:00
ğŸ’Š Ğ•ÑÑ‚ÑŒ Ğ²ĞµÑ‚Ğ°Ğ¿Ñ‚ĞµĞºĞ°
ğŸš« ĞĞ° Ğ´Ğ¾Ğ¼ Ğ½Ğµ Ğ²Ñ‹ĞµĞ·Ğ¶Ğ°ÑÑ‚
ğŸ‘©â€âš•ï¸ Ğ•Ğ²Ğ³ĞµĞ½Ğ¸Ñ ĞšĞ¾Ğ½Ğ¾Ğ½ĞµĞ½ĞºĞ¾: +7 (978) 804-22-62

4ï¸âƒ£ <b>Ğ¯Ğ»Ñ‚Ğ¸Ğ½ÑĞºĞ¸Ğ¹ Ğ²ĞµÑ‚ĞµÑ€Ğ¸Ğ½Ğ°Ñ€Ğ½Ñ‹Ğ¹ Ğ³Ğ¾ÑĞ¿Ğ¸Ñ‚Ğ°Ğ»ÑŒ</b>
ğŸ“Œ ÑƒĞ». Ğ¢Ğ¸Ğ¼Ğ¸Ñ€ÑĞ·ĞµĞ²Ğ°, 33
ğŸ•’ ĞšÑ€ÑƒĞ³Ğ»Ğ¾ÑÑƒÑ‚Ğ¾Ñ‡Ğ½Ğ¾, ĞºÑ€Ğ¾Ğ¼Ğµ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ñ… (Ğ´Ğ¾ 15:00)
ğŸ§ª Ğ£Ğ—Ğ˜, Ğ»Ğ°Ğ±Ğ¾Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¸Ñ, Ñ€ĞµĞ½Ñ‚Ğ³ĞµĞ½, Ğ­ĞšĞ“
ğŸš« ĞĞ° Ğ´Ğ¾Ğ¼ Ğ½Ğµ Ğ²Ñ‹ĞµĞ·Ğ¶Ğ°ÑÑ‚
ğŸ“ +7 (978) 711-67-62

5ï¸âƒ£ <b>ĞšĞ»Ğ¸Ğ½Ğ¸ĞºĞ° "Ğ¤Ğ°ÑƒĞ½Ğ°"</b>
ğŸ“Œ ÑƒĞ». Ğ˜Ğ·Ğ¾Ğ±Ğ¸Ğ»ÑŒĞ½Ğ°Ñ, 20 (Ğ½Ğ°Ğ¿Ñ€Ğ¾Ñ‚Ğ¸Ğ² ĞœĞ§Ğ¡)
ğŸ•’ ĞŸĞ½â€“ĞŸÑ‚: 9:00â€“18:00; Ğ¡Ğ±â€“Ğ’Ñ: Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹
ğŸ’Š Ğ’ĞµÑ‚Ğ°Ğ¿Ñ‚ĞµĞºĞ°, Ñ€ĞµĞ½Ñ‚Ğ³ĞµĞ½
ğŸ“ +7 (978) 988-51-05
ğŸ”— <a href="https://vk.com/vetclinica_fauna_yalta">VK ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ°</a>

---SPLIT---

6ï¸âƒ£ <b>ĞšĞ»Ğ¸Ğ½Ğ¸ĞºĞ° "Ğ¥Ğ°Ñ‚Ğ¸ĞºĞ¾"</b>
ğŸ“Œ ÑƒĞ». ĞœĞ¾ÑĞºĞ¾Ğ²ÑĞºĞ°Ñ, 59 (Ğ¾ÑÑ‚. ĞĞ²Ñ‚Ğ¾Ğ²Ğ¾ĞºĞ·Ğ°Ğ»)
ğŸ•’ ĞŸĞ½â€“Ğ’Ñ: 9:00â€“21:00
ğŸ’Š Ğ’ĞµÑ‚Ğ°Ğ¿Ñ‚ĞµĞºĞ°, Ğ£Ğ—Ğ˜, Ñ€ĞµĞ½Ñ‚Ğ³ĞµĞ½, Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· ĞºÑ€Ğ¾Ğ²Ğ¸
ğŸ ĞŸÑ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ÑÑ‚ ÑĞºĞ·Ğ¾Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ğ¶Ğ¸Ğ²Ğ¾Ñ‚Ğ½Ñ‹Ñ…
ğŸ  Ğ’Ñ‹ĞµĞ·Ğ´ Ğ½Ğ° Ğ´Ğ¾Ğ¼: 2000 Ñ€ÑƒĞ±.
ğŸ“ +7 (978) 725-91-59, +7 (978) 106-72-06

7ï¸âƒ£ <b>ĞšĞ»Ğ¸Ğ½Ğ¸ĞºĞ° "Ğ”Ğ¾Ğ²ĞµÑ€Ğ¸Ğµ"</b>
ğŸ“Œ ÑƒĞ». Ğ¥Ğ°Ğ»Ñ‚ÑƒÑ€Ğ¸Ğ½Ğ°, 52Ğ
ğŸ•’ ĞŸĞ½â€“Ğ’Ñ: 9:00â€“21:00
ğŸ’‰ Ğ¡Ñ‚Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ°Ñ€, Ğ·Ğ¾Ğ¾Ğ³Ğ¾ÑÑ‚Ğ¸Ğ½Ğ¸Ñ†Ğ°, Ğ´Ğ¾Ğ½Ğ¾Ñ€ÑĞºĞ°Ñ Ğ±Ğ°Ğ·Ğ°
ğŸ’Š Ğ£Ğ—Ğ˜, Ğ­Ğ¥Ğ ÑĞµÑ€Ğ´Ñ†Ğ°, Ñ€ĞµĞ½Ñ‚Ğ³ĞµĞ½
ğŸ Ğ­ĞºĞ·Ğ¾Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ¶Ğ¸Ğ²Ğ¾Ñ‚Ğ½Ñ‹Ğµ
ğŸš« ĞĞ° Ğ´Ğ¾Ğ¼ Ğ½Ğµ Ğ²Ñ‹ĞµĞ·Ğ¶Ğ°ÑÑ‚
ğŸ“ +7 (978) 256-15-01, +7 (978) 976-84-34
ğŸ”— <a href="https://vk.com/doverieyalta">VK ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ°</a>

8ï¸âƒ£ <b>Ğ“Ğ¾Ñ. Ğ²ĞµÑ‚Ğ»ĞµÑ‡ĞµĞ±Ğ½Ğ¸Ñ†Ğ°</b>
ğŸ“Œ ÑƒĞ». Ğ¡Ğ°Ñ…Ğ°Ğ½Ñ, 5
ğŸ•’ ĞŸĞ½â€“ĞŸÑ‚: 8:00â€“16:00; Ğ¡Ğ±â€“Ğ’Ñ: Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹
ğŸ‘¨â€âš•ï¸ ĞĞ¸ĞºĞ¾Ğ»Ğ°Ğ¹ Ğ‘Ğ¾Ñ€Ğ¸ÑĞ¾Ğ²Ğ¸Ñ‡
ğŸ“ +7 (978) 860-36-98, +7 (3654) 23-78-14
ğŸ”— <a href="https://vk.com/yaltavetmed">VK ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ°</a>

9ï¸âƒ£ <b>ĞšĞ»Ğ¸Ğ½Ğ¸ĞºĞ° Ğ®Ğ»Ğ¸Ğ¸ Ğ¢ĞµÑ€ĞµÑ‰ÑƒĞº</b>
ğŸ“Œ ÑƒĞ». ĞœĞ¾ÑĞºĞ¾Ğ²ÑĞºĞ°Ñ, 31 (ĞœĞ¾ÑĞºĞ¾Ğ²ÑĞºĞ¸Ğ¹ Ğ–Ğš ğŸ£)
ğŸ•’ 9:00â€“19:00
ğŸ  Ğ¡Ñ€Ğ¾Ñ‡Ğ½Ñ‹Ğ¹ Ğ²Ñ‹Ğ·Ğ¾Ğ² Ğ²Ñ€Ğ°Ñ‡Ğ° Ğ½Ğ° Ğ´Ğ¾Ğ¼: 1500 Ñ€ÑƒĞ±.
ğŸ“ 8 800 302-82-84, +7 (978) 290-64-05

ğŸ”Ÿ <b>Ğ¢ĞµĞ¼ĞµÑˆĞµĞ² Ğ ÑƒÑĞ»Ğ°Ğ½</b>
ğŸ“ +7 (978) 854-00-25
ğŸ  Ğ’Ñ‹ĞµĞ·Ğ´ Ğ½Ğ° Ğ´Ğ¾Ğ¼""",
            
            "Ğ³ÑƒÑ€Ğ·ÑƒÑ„": """<b>ğŸ“ Ğ“Ğ£Ğ Ğ—Ğ£Ğ¤</b>

1ï¸âƒ£ <b>ĞÑ€Ñ…Ğ°Ğ½Ğ³ĞµĞ»ÑŒÑĞºĞ°Ñ Ğ¡Ğ²ĞµÑ‚Ğ»Ğ°Ğ½Ğ° Ğ’Ğ»Ğ°Ğ´Ğ¸Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ½Ğ°</b>
ğŸ“Œ ÑƒĞ». Ğ›ĞµĞ½Ğ¸Ğ½Ğ³Ñ€Ğ°Ğ´ÑĞºĞ°Ñ, 66
ğŸ•’ ĞŸĞ½â€“ĞŸÑ‚: 8:30â€“14:00; Ğ¡Ğ±: 8:30â€“12:00; Ğ’Ñ: Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹
ğŸ“ +7 (978) 707-71-03""",
            
            "Ğ³Ğ°ÑĞ¿Ñ€Ğ°": """<b>ğŸ“ Ğ“ĞĞ¡ĞŸĞ Ğ</b>

1ï¸âƒ£ <b>Ğ’ĞµÑ‚ĞºĞ°Ğ±Ğ¸Ğ½ĞµÑ‚ "ĞœĞ¾ĞºÑ€Ñ‹Ğ¹ Ğ½Ğ¾Ñ"</b>
ğŸ“Œ Ğ¡ĞµĞ²Ğ°ÑÑ‚Ğ¾Ğ¿Ğ¾Ğ»ÑŒÑĞºĞ¾Ğµ ÑˆĞ¾ÑÑĞµ, 21
ğŸ•’ ĞŸĞ½â€“ĞŸÑ‚: 9:00â€“18:00
ğŸ“ +7 (918) 917-18-29
ğŸ”— <a href="https://vk.com/club214152926">VK ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ°</a>""",
            
            "ĞºĞ¾Ñ€ĞµĞ¸Ğ·": """<b>ğŸ“ ĞšĞĞ Ğ•Ğ˜Ğ—</b>

1ï¸âƒ£ <b>Ğ’ĞµÑ‚ "Ğ—Ğ°Ğ±Ğ¾Ñ‚Ğ°"</b>
ğŸ“Œ ÑƒĞ». ĞœĞ°ÑĞºĞ¾Ğ²ÑĞºĞ¾Ğ³Ğ¾, 2Ğ‘
ğŸ•’ Ğ’Ñ‚â€“ĞŸÑ‚: 9:00â€“19:00; Ğ¡Ğ±â€“Ğ’Ñ: 10:00â€“16:00; ĞŸĞ½: Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹
ğŸ’‰ Ğ›ÑŒĞ³Ğ¾Ñ‚Ğ½Ğ°Ñ ÑÑ‚ĞµÑ€Ğ¸Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
ğŸ“ +7 (978) 651-07-47""",
            
            "Ğ°Ğ»ÑƒĞ¿ĞºĞ°": """<b>ğŸ“ ĞĞ›Ğ£ĞŸĞšĞ</b>

1ï¸âƒ£ <b>ĞœĞ°Ğ¹Ñ Ğ“ĞµĞ¾Ñ€Ğ³Ğ¸ĞµĞ²Ğ½Ğ°</b>
ğŸ  Ğ’Ñ‹ĞµĞ·Ğ´ Ğ½Ğ° Ğ´Ğ¾Ğ¼
ğŸ“ +7 (978) 805-10-63

2ï¸âƒ£ <b>Ğ’ĞµÑ‚Ğ¿ÑƒĞ½ĞºÑ‚ "Ğ”Ğ°Ğ¹ Ğ»Ğ°Ğ¿Ñƒ!"</b>
ğŸ“Œ ÑƒĞ». Ğ—Ğ°Ğ¿Ğ°Ğ´Ğ½Ğ°Ñ, 22Ğ‘
ğŸ•’ ĞŸĞ½â€“Ğ¡Ğ±: 9:00â€“18:00; Ğ’Ñ: Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹
ğŸ“ +7 (978) 083-90-99

3ï¸âƒ£ <b>Ğ“Ğ¾Ñ€Ğ¾Ğ´ÑĞºĞ¾Ğ¹ Ğ²ĞµÑ‚Ñ†ĞµĞ½Ñ‚Ñ€</b>
ğŸ“Œ ÑƒĞ». ĞĞ°Ğ³Ğ¾Ñ€Ğ½Ğ°Ñ, 70
ğŸ•’ ĞŸĞ½â€“ĞŸÑ‚: 8:00â€“14:00; Ğ¡Ğ±â€“Ğ’Ñ: Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹
ğŸ“ +7 (978) 806-89-63""",
            
            "ÑĞ¸Ğ¼ĞµĞ¸Ğ·": """<b>ğŸ“ Ğ¡Ğ˜ĞœĞ•Ğ˜Ğ—</b>

ğŸ‘©â€âš•ï¸ Ğ®Ğ»Ğ¸Ñ Ğ›Ğ¸ÑĞ¾Ğ³Ğ¾Ñ€
ğŸ“ +7 (978) 806-17-82""",
            
            "Ğ¾Ğ¿Ğ¾Ğ»Ğ·Ğ½ĞµĞ²Ğ¾Ğµ": """<b>ğŸ“ ĞĞŸĞĞ›Ğ—ĞĞ•Ğ’ĞĞ•</b>

ğŸ‘©â€âš•ï¸ Ğ¡Ğ²ĞµÑ‚Ğ»Ğ°Ğ½Ğ° ĞĞ»ĞµĞºÑĞ°Ğ½Ğ´Ñ€Ğ¾Ğ²Ğ½Ğ°
ğŸ“ +7 (978) 776-31-81
ğŸ  Ğ’Ñ‹ĞµĞ·Ğ´ Ğ½Ğ° Ğ´Ğ¾Ğ¼"""
        }
        
        return clinics_data.get(city.lower(), "âš ï¸ Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ Ğ´Ğ°Ğ½Ğ½Ğ¾Ğ¼Ñƒ Ğ³Ğ¾Ñ€Ğ¾Ğ´Ñƒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°")

    def setup_handlers(self):
        """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹"""
        
        @self.bot.message_handler(commands=['start'])
        def start_handler(message):
            self.stats["users"].add(message.from_user.id)
            self.stats["messages"] += 1
            
            welcome_text = """ğŸ‘‹ <b>Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ² "ĞšĞ¾Ñ‚Ğ¸ĞºĞ¸ Ğ¯Ğ»Ñ‚Ñ‹"!</b>

ğŸ¾ ĞŸĞ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸Ğº Ğ¿Ğ¾ ĞºĞ¾ÑˆĞºĞ°Ğ¼ Ğ¯Ğ»Ñ‚Ñ‹

Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ€Ğ°Ğ·Ğ´ĞµĞ»:
ğŸ¥ <b>Ğ¡Ñ‚ĞµÑ€Ğ¸Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ</b> - Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ
ğŸ  <b>ĞŸÑ€Ğ¸ÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ¾</b> - ĞºĞ¾Ñ‚Ğ¸ĞºĞ¸ Ğ¸Ñ‰ÑƒÑ‚ Ğ´Ğ¾Ğ¼
ğŸ“ <b>ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹</b> - ĞºĞ»Ğ¸Ğ½Ğ¸ĞºĞ¸ Ğ¸ Ğ²Ğ¾Ğ»Ğ¾Ğ½Ñ‚ĞµÑ€Ñ‹
â„¹ï¸ <b>Ğ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğµ</b> - Ğ½Ğ°ÑˆĞ° Ğ´ĞµÑÑ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ
ğŸ± <b>ĞĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ğ¾ÑÑ‚Ñ‹</b> - ÑĞ²ĞµĞ¶Ğ¸Ğµ Ğ¾Ğ±ÑŠÑĞ²Ğ»ĞµĞ½Ğ¸Ñ"""
            
            self.bot.send_message(
                message.chat.id, 
                welcome_text, 
                parse_mode="HTML",
                reply_markup=self.get_main_keyboard()
            )
        
        @self.bot.message_handler(commands=['update'])
        def update_handler(message):
            """ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ² (Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ²)"""
            if message.from_user.id not in [123456789]:  # Ğ—Ğ°Ğ¼ĞµĞ½Ğ¸Ñ‚Ğµ Ğ½Ğ° Ğ²Ğ°Ñˆ ID
                return
                
            self.parser.posts_cache = []
            self.parser.last_update = None
            self.bot.send_message(message.chat.id, "ğŸ”„ ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑÑ Ğ¿Ğ¾ÑÑ‚Ñ‹...")
            posts = self.parser.get_channel_posts()
            self.bot.send_message(
                message.chat.id, 
                f"âœ… ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾: {len(posts)} Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ² (Ñ Ğ¼ĞµĞ´Ğ¸Ğ°: {sum(1 for p in posts if p['has_media'])})"
            )
        
        @self.bot.message_handler(func=lambda m: m.text == "ğŸ¥ Ğ¡Ñ‚ĞµÑ€Ğ¸Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ")
        def sterilization_handler(message):
            self.stats["users"].add(message.from_user.id)
            self.stats["messages"] += 1
            
            try:
                with open('assets/images/sterilization.jpg', 'rb') as photo:
                    self.bot.send_photo(
                        message.chat.id,
                        photo,
                        caption="ğŸ¥ <b>Ğ¡Ñ‚ĞµÑ€Ğ¸Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ĞºĞ¾ÑˆĞµĞº</b>\n\nĞ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚:",
                        parse_mode="HTML",
                        reply_markup=self.get_sterilization_keyboard()
                    )
            except Exception as e:
                logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ñ„Ğ¾Ñ‚Ğ¾: {e}")
                self.bot.send_message(
                    message.chat.id,
                    "ğŸ¥ <b>Ğ¡Ñ‚ĞµÑ€Ğ¸Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ĞºĞ¾ÑˆĞµĞº</b>\n\nĞ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚:",
                    parse_mode="HTML",
                    reply_markup=self.get_sterilization_keyboard()
                )
        
        @self.bot.message_handler(func=lambda m: m.text == "ğŸ’° ĞŸĞ»Ğ°Ñ‚Ğ½Ğ°Ñ ÑÑ‚ĞµÑ€Ğ¸Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ")
        def paid_sterilization_handler(message):
            self.bot.send_message(
                message.chat.id,
                self.load_html_file('paid_text.html'),
                parse_mode="HTML"
            )
        
        @self.bot.message_handler(func=lambda m: m.text == "ğŸ†“ Ğ‘ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ğ°Ñ ÑÑ‚ĞµÑ€Ğ¸Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ")
        def free_sterilization_handler(message):
            self.bot.send_message(
                message.chat.id,
                self.load_html_file('free_text.html'),
                parse_mode="HTML"
            )
        
        @self.bot.message_handler(func=lambda m: m.text == "ğŸ± ĞĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ğ¾ÑÑ‚Ñ‹")
        def recent_posts_handler(message):
            self.send_channel_posts(message.chat.id)
        
        @self.bot.message_handler(func=lambda m: m.text == "ğŸ“ ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹")
        def contacts_handler(message):
            self.stats["users"].add(message.from_user.id)
            self.stats["messages"] += 1
            
            contacts_text = """ğŸ“ <b>ĞšĞĞĞ¢ĞĞšĞ¢Ğ«</b>

Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ:

ğŸ¥ <b>ĞšĞ»Ğ¸Ğ½Ğ¸ĞºĞ¸</b>
Ğ’ĞµÑ‚ĞµÑ€Ğ¸Ğ½Ğ°Ñ€Ğ½Ñ‹Ğµ ĞºĞ»Ğ¸Ğ½Ğ¸ĞºĞ¸ Ğ¿Ğ¾ Ğ³Ğ¾Ñ€Ğ¾Ğ´Ğ°Ğ¼

ğŸ¤ <b>Ğ’Ğ¾Ğ»Ğ¾Ğ½Ñ‚ĞµÑ€Ñ‹</b>
ĞšĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ğ¾Ñ€Ñ‹ Ğ¸ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ¸ÑÑ‚Ñ‹"""
            
            self.bot.send_message(
                message.chat.id, 
                contacts_text, 
                parse_mode="HTML",
                reply_markup=self.get_contacts_keyboard()
            )
        
        @self.bot.message_handler(func=lambda m: m.text == "ğŸ¥ ĞšĞ»Ğ¸Ğ½Ğ¸ĞºĞ¸")
        def clinics_handler(message):
            self.bot.send_message(
                message.chat.id,
                "ğŸ¥ <b>Ğ’Ğ•Ğ¢Ğ•Ğ Ğ˜ĞĞĞ ĞĞ«Ğ• ĞšĞ›Ğ˜ĞĞ˜ĞšĞ˜</b>\n\nĞ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ³Ğ¾Ñ€Ğ¾Ğ´:",
                parse_mode="HTML",
                reply_markup=self.get_clinics_keyboard()
            )
        
        @self.bot.message_handler(func=lambda m: m.text == "ğŸ¤ Ğ’Ğ¾Ğ»Ğ¾Ğ½Ñ‚ĞµÑ€Ñ‹")
        def volunteers_handler(message):
            volunteers_text = """ğŸ¤ <b>Ğ’ĞĞ›ĞĞĞ¢Ğ•Ğ Ğ« Ğ˜ ĞšĞĞĞ Ğ”Ğ˜ĞĞĞ¢ĞĞ Ğ«</b>

ğŸ‘¥ <b>ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ğ¾Ñ€Ñ‹:</b>
ğŸ”¹ ĞŸĞ¾ ĞºĞ¾ÑˆĞºĞ°Ğ¼: +7 978 144-90-70
ğŸ”¹ ĞŸĞ¾ ÑÑ‚ĞµÑ€Ğ¸Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸: +7 978 000-00-02
ğŸ”¹ Ğ›ĞµÑ‡ĞµĞ½Ğ¸Ğµ: +7 978 000-00-03

ğŸ“± <b>Ğ¡Ğ¾Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ ÑĞµÑ‚Ğ¸:</b>
ğŸ”¹ Telegram: @cats_yalta
ğŸ”¹ Instagram: @yalta_cats

ğŸ’¬ <b>Ğ“Ñ€ÑƒĞ¿Ğ¿Ñ‹ Ğ²Ğ¾Ğ»Ğ¾Ğ½Ñ‚ĞµÑ€Ğ¾Ğ²:</b>
ğŸ”¹ <a href="https://t.me/cats_yalta">ĞšĞ¾Ñ‚Ğ¸ĞºĞ¸ Ğ¯Ğ»Ñ‚Ğ° (ĞºĞ°Ğ½Ğ°Ğ»)</a>
ğŸ”¹ <a href="https://t.me/cats_yalta_group">ĞšĞ¾Ñ‚Ğ¸ĞºĞ¸ Ğ¯Ğ»Ñ‚Ğ° (Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ°)</a>

ğŸ¤ <b>Ğ¡Ñ‚Ğ°Ñ‚ÑŒ Ğ²Ğ¾Ğ»Ğ¾Ğ½Ñ‚ĞµÑ€Ğ¾Ğ¼:</b>
ĞŸĞ¸ÑˆĞ¸Ñ‚Ğµ @cats_yalta_coordinator

ğŸ’° <b>ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ Ñ„Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ğ¾:</b>
ĞšĞ°Ñ€Ñ‚Ğ°: 2202 2020 0000 0000
(Ñ€ĞµĞºĞ²Ğ¸Ğ·Ğ¸Ñ‚Ñ‹ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ¶ĞµÑ€Ñ‚Ğ²Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹)"""
            
            self.bot.send_message(
                message.chat.id, 
                volunteers_text, 
                parse_mode="HTML"
            )
        
        # ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸ Ğ³Ğ¾Ñ€Ğ¾Ğ´Ğ¾Ğ² Ğ´Ğ»Ñ ĞºĞ»Ğ¸Ğ½Ğ¸Ğº
        @self.bot.message_handler(func=lambda m: m.text in ["ğŸ›ï¸ Ğ¯Ğ»Ñ‚Ğ°", "ğŸŒŠ Ğ“ÑƒÑ€Ğ·ÑƒÑ„", "ğŸ”ï¸ Ğ“Ğ°ÑĞ¿Ñ€Ğ°", "ğŸŒ… ĞšĞ¾Ñ€ĞµĞ¸Ğ·", "ğŸ–ï¸ ĞĞ»ÑƒĞ¿ĞºĞ°", "ğŸŒ² Ğ¡Ğ¸Ğ¼ĞµĞ¸Ğ·", "â›°ï¸ ĞĞ¿Ğ¾Ğ»Ğ·Ğ½ĞµĞ²Ğ¾Ğµ"])
        def city_clinics_handler(message):
            city_emoji_map = {
                "ğŸ›ï¸ Ğ¯Ğ»Ñ‚Ğ°": "ÑĞ»Ñ‚Ğ°",
                "ğŸŒŠ Ğ“ÑƒÑ€Ğ·ÑƒÑ„": "Ğ³ÑƒÑ€Ğ·ÑƒÑ„", 
                "ğŸ”ï¸ Ğ“Ğ°ÑĞ¿Ñ€Ğ°": "Ğ³Ğ°ÑĞ¿Ñ€Ğ°",
                "ğŸŒ… ĞšĞ¾Ñ€ĞµĞ¸Ğ·": "ĞºĞ¾Ñ€ĞµĞ¸Ğ·",
                "ğŸ–ï¸ ĞĞ»ÑƒĞ¿ĞºĞ°": "Ğ°Ğ»ÑƒĞ¿ĞºĞ°",
                "ğŸŒ² Ğ¡Ğ¸Ğ¼ĞµĞ¸Ğ·": "ÑĞ¸Ğ¼ĞµĞ¸Ğ·",
                "â›°ï¸ ĞĞ¿Ğ¾Ğ»Ğ·Ğ½ĞµĞ²Ğ¾Ğµ": "Ğ¾Ğ¿Ğ¾Ğ»Ğ·Ğ½ĞµĞ²Ğ¾Ğµ"
            }
            
            city = city_emoji_map.get(message.text, "")
            if city:
                clinic_info = self.get_clinics_by_city(city)
                self.send_long_message(message.chat.id, clinic_info)
        
        @self.bot.message_handler(func=lambda m: True)
        def message_handler(message):
            self.stats["users"].add(message.from_user.id)
            self.stats["messages"] += 1
            
            text = message.text
            chat_id = message.chat.id
            
            try:
                if text == "ğŸ  ĞŸÑ€Ğ¸ÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ¾":
                    info_text = """ğŸ  <b>ĞŸÑ€Ğ¸ÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ¾ ĞºĞ¾Ñ‚Ğ¸ĞºĞ¾Ğ²</b>

Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ:

ğŸ± <b>ĞšĞ¾ÑˆĞºĞ¸ Ğ¸Ñ‰ÑƒÑ‚ Ğ´Ğ¾Ğ¼</b>
ĞĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¾Ğ±ÑŠÑĞ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¸Ğ· Ğ³Ñ€ÑƒĞ¿Ğ¿

ğŸ“ <b>ĞŸĞ¾Ğ´Ğ°Ñ‚ÑŒ Ğ¾Ğ±ÑŠÑĞ²Ğ»ĞµĞ½Ğ¸Ğµ</b>
ĞšĞ°Ğº Ñ€Ğ°Ğ·Ğ¼ĞµÑÑ‚Ğ¸Ñ‚ÑŒ ÑĞ²Ğ¾Ğµ Ğ¾Ğ±ÑŠÑĞ²Ğ»ĞµĞ½Ğ¸Ğµ"""
                    
                    self.bot.send_message(
                        chat_id, 
                        info_text, 
                        parse_mode="HTML",
                        reply_markup=self.get_adoption_keyboard()
                    )
                
                elif text == "ğŸ± ĞšĞ¾ÑˆĞºĞ¸ Ğ¸Ñ‰ÑƒÑ‚ Ğ´Ğ¾Ğ¼":
                    self.send_channel_posts(chat_id)
                
                elif text == "ğŸ“ ĞŸĞ¾Ğ´Ğ°Ñ‚ÑŒ Ğ¾Ğ±ÑŠÑĞ²Ğ»ĞµĞ½Ğ¸Ğµ":
                    info_text = f"""ğŸ“ <b>ĞŸĞ¾Ğ´Ğ°Ñ‚ÑŒ Ğ¾Ğ±ÑŠÑĞ²Ğ»ĞµĞ½Ğ¸Ğµ</b>

ğŸ“¢ <b>Ğ“Ñ€ÑƒĞ¿Ğ¿Ñ‹ Ğ´Ğ»Ñ Ğ¾Ğ±ÑŠÑĞ²Ğ»ĞµĞ½Ğ¸Ğ¹:</b>
â€¢ <a href="{self.parser.channels[0]['url']}">ĞšĞ¾Ñ‚Ğ¸ĞºĞ¸ Ğ¯Ğ»Ñ‚Ğ° (ĞºĞ°Ğ½Ğ°Ğ»)</a>
â€¢ <a href="{self.parser.channels[1]['url']}">ĞšĞ¾Ñ‚Ğ¸ĞºĞ¸ Ğ¯Ğ»Ñ‚Ğ° (Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ°)</a>

âœï¸ <b>ĞšĞ°Ğº Ğ¿Ğ¾Ğ´Ğ°Ñ‚ÑŒ:</b>
1ï¸âƒ£ ĞŸĞµÑ€ĞµĞ¹Ñ‚Ğ¸ Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿Ñƒ
2ï¸âƒ£ ĞĞ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°Ğ¼
3ï¸âƒ£ Ğ˜Ğ»Ğ¸ ÑĞ²ÑĞ·Ğ°Ñ‚ÑŒÑÑ Ñ ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼: +7 978 000-00-01

ğŸ“‹ <b>ĞÑƒĞ¶Ğ½Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ:</b>
ğŸ”¹ Ğ¤Ğ¾Ñ‚Ğ¾ Ğ¶Ğ¸Ğ²Ğ¾Ñ‚Ğ½Ğ¾Ğ³Ğ¾
ğŸ”¹ Ğ’Ğ¾Ğ·Ñ€Ğ°ÑÑ‚, Ğ¿Ğ¾Ğ», Ğ¾ĞºÑ€Ğ°Ñ
ğŸ”¹ Ğ¥Ğ°Ñ€Ğ°ĞºÑ‚ĞµÑ€
ğŸ”¹ Ğ—Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒĞµ (Ğ¿Ñ€Ğ¸Ğ²Ğ¸Ğ²ĞºĞ¸, ÑÑ‚ĞµÑ€Ğ¸Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ)
ğŸ”¹ Ğ’Ğ°ÑˆĞ¸ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹"""
                    
                    self.bot.send_message(chat_id, info_text, parse_mode="HTML")
                
                elif text == "â„¹ï¸ Ğ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğµ":
                    about_text = """â„¹ï¸ <b>Ğ ĞŸĞ ĞĞ•ĞšĞ¢Ğ• "ĞšĞĞ¢Ğ˜ĞšĞ˜ Ğ¯Ğ›Ğ¢Ğ«"</b>

ğŸ¯ <b>ĞœĞ¸ÑÑĞ¸Ñ:</b>
ĞŸĞ¾Ğ¼Ğ¾Ñ‰ÑŒ Ğ±ĞµĞ·Ğ´Ğ¾Ğ¼Ğ½Ñ‹Ğ¼ ĞºĞ¾ÑˆĞºĞ°Ğ¼ Ğ¯Ğ»Ñ‚Ñ‹

ğŸ“Š <b>Ğ”Ğ¾ÑÑ‚Ğ¸Ğ¶ĞµĞ½Ğ¸Ñ:</b>
ğŸ”¹ Ğ¡Ñ‚ĞµÑ€Ğ¸Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ¾: 500+ ĞºĞ¾ÑˆĞµĞº
ğŸ”¹ ĞŸÑ€Ğ¸ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¾: 300+ ĞºĞ¾Ñ‚ÑÑ‚
ğŸ”¹ Ğ’Ğ¾Ğ»Ğ¾Ğ½Ñ‚ĞµÑ€Ğ¾Ğ²: 30+ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ…

ğŸ’° <b>ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ:</b>
ĞšĞ°Ñ€Ñ‚Ğ°: 2202 2020 0000 0000

ğŸ¤ <b>Ğ¡Ñ‚Ğ°Ñ‚ÑŒ Ğ²Ğ¾Ğ»Ğ¾Ğ½Ñ‚ĞµÑ€Ğ¾Ğ¼:</b>
ĞŸĞ¸ÑˆĞ¸Ñ‚Ğµ @cats_yalta_coordinator"""
                    
                    self.bot.send_message(chat_id, about_text, parse_mode="HTML")
                
                elif text == "ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´":
                    self.bot.send_message(
                        chat_id, 
                        "ğŸ  Ğ“Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ:", 
                        reply_markup=self.get_main_keyboard()
                    )
                
                else:
                    self.bot.send_message(
                        chat_id,
                        "â“ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ¼ĞµĞ½Ñ\n\n/start - Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ",
                        reply_markup=self.get_main_keyboard()
                    )
                    
            except Exception as e:
                logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸: {e}")
                self.bot.send_message(chat_id, "âš ï¸ ĞÑˆĞ¸Ğ±ĞºĞ°. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ /start")
    
    def setup_routes(self):
        """Flask Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹"""
        
        @self.app.route(f'/{self.token}', methods=['POST'])
        def webhook():
            try:
                if request.headers.get('content-type') == 'application/json':
                    json_string = request.get_data().decode('utf-8')
                    update = telebot.types.Update.de_json(json_string)
                    self.bot.process_new_updates([update])
                    return '', 200
                return 'Bad request', 400
            except Exception as e:
                logger.error(f"âŒ Webhook Ğ¾ÑˆĞ¸Ğ±ĞºĞ°: {e}")
                return 'Internal error', 500
        
        @self.app.route('/')
        def home():
            return jsonify({
                "status": "ğŸ¤– Cat Bot Running",
                "time": datetime.now().strftime('%H:%M:%S'),
                "users": len(self.stats["users"]),
                "messages": self.stats["messages"],
                "channels": [c['url'] for c in self.parser.channels],
                "last_update": self.parser.last_update.isoformat() if self.parser.last_update else None
            })
        
        @self.app.route('/posts')
        def posts_api():
            try:
                posts = self.parser.get_cached_posts()
                return jsonify({
                    "status": "ok",
                    "count": len(posts),
                    "posts": [{
                        "title": p["title"],
                        "url": p["url"],
                        "date": p["date"],
                        "channel": p["channel"]
                    } for p in posts],
                    "channels": [c['url'] for c in self.parser.channels]
                })
            except Exception as e:
                return jsonify({"status": "error", "message": str(e)}), 500
    
    def setup_webhook(self) -> bool:
        """ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° webhook"""
        try:
            self.bot.remove_webhook()
            time.sleep(2)
            
            if not self.webhook_url:
                logger.error("âŒ WEBHOOK_URL Ğ½Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½!")
                return False
            
            full_url = f"https://{self.webhook_url}/{self.token}"
            result = self.bot.set_webhook(url=full_url)
            
            if result:
                logger.info(f"âœ… Webhook: {full_url}")
                return True
            else:
                logger.error("âŒ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ webhook")
                return False
                
        except Exception as e:
            logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° webhook: {e}")
            return False
    
    def run(self):
        """Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ±Ğ¾Ñ‚Ğ°"""
        logger.info("ğŸš€ Ğ—Ğ°Ğ¿ÑƒÑĞº CatBot Ğ´Ğ»Ñ Ğ¯Ğ»Ñ‚Ñ‹...")
        
        # ĞŸÑ€ĞµĞ´Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ²
        try:
            posts = self.parser.get_cached_posts()
            logger.info(f"âœ… ĞŸÑ€ĞµĞ´Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ¾ {len(posts)} Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ²")
        except Exception as e:
            logger.warning(f"âš ï¸ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€ĞµĞ´Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸: {e}")
        
        if self.setup_webhook():
            self.app.run(host='0.0.0.0', port=self.port)
        else:
            logger.error("ğŸš¨ ĞÑˆĞ¸Ğ±ĞºĞ° webhook, Ğ·Ğ°Ğ¿ÑƒÑĞº Ğ² polling Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ")
            self.bot.polling()

if __name__ == "__main__":
    # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ğµ Ğ¿Ğ°Ğ¿ĞºĞ¸ Ğ¸ Ñ„Ğ°Ğ¹Ğ»Ñ‹, ĞµÑĞ»Ğ¸ Ğ¸Ñ… Ğ½ĞµÑ‚
    os.makedirs('assets/images', exist_ok=True)
    
    # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¾ ÑÑ‚ĞµÑ€Ğ¸Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
    if not os.path.exists('assets/free_text.html'):
        with open('assets/free_text.html', 'w', encoding='utf-8') as f:
            f.write("""<b>ğŸ¾ Ğ‘Ğ•Ğ¡ĞŸĞ›ĞĞ¢ĞĞĞ¯ Ğ¡Ğ¢Ğ•Ğ Ğ˜Ğ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯ ĞšĞĞ¨Ğ•Ğš</b>

ğŸ¥ <b>ĞŸÑ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ñ‹:</b>
ğŸ”¹ ĞœÑƒĞ½Ğ¸Ñ†Ğ¸Ğ¿Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ° Ğ¯Ğ»Ñ‚Ñ‹
ğŸ”¹ Ğ‘Ğ»Ğ°Ğ³Ğ¾Ñ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ñ„Ğ¾Ğ½Ğ´Ñ‹

ğŸ“‹ <b>Ğ£ÑĞ»Ğ¾Ğ²Ğ¸Ñ:</b>
âœ… Ğ‘ĞµĞ·Ğ´Ğ¾Ğ¼Ğ½Ñ‹Ğµ ĞºĞ¾ÑˆĞºĞ¸
âœ… ĞšĞ¾ÑˆĞºĞ¸ Ğ¸Ğ· Ğ¼Ğ°Ğ»Ğ¾Ğ¸Ğ¼ÑƒÑ‰Ğ¸Ñ… ÑĞµĞ¼ĞµĞ¹
âœ… ĞŸĞ¾ Ğ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ²Ğ¾Ğ»Ğ¾Ğ½Ñ‚ĞµÑ€Ğ¾Ğ²

ğŸ“ <b>ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹:</b>
ğŸ”¹ ĞšĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ğ¾Ñ€: +7 978 144-90-70
ğŸ”¹ ĞšĞ»Ğ¸Ğ½Ğ¸ĞºĞ° "ĞĞ¹Ğ±Ğ¾Ğ»Ğ¸Ñ‚": +7 978 000-00-11

ğŸ“ <b>ĞĞ´Ñ€ĞµÑĞ°:</b>
ÑƒĞ». ĞšĞ¸Ñ€Ğ¾Ğ²Ğ°, 15 (Ğ¿Ğ½-Ğ¿Ñ‚ 9:00-18:00)""")

    if not os.path.exists('assets/paid_text.html'):
        with open('assets/paid_text.html', 'w', encoding='utf-8') as f:
            f.write("""<b>ğŸ’µ ĞŸĞ›ĞĞ¢ĞĞĞ¯ Ğ¡Ğ¢Ğ•Ğ Ğ˜Ğ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯ ĞšĞĞ¨Ğ•Ğš</b>

ğŸ¥ <b>ĞšĞ»Ğ¸Ğ½Ğ¸ĞºĞ¸:</b>
ğŸ”¹ "ĞĞ¹Ğ±Ğ¾Ğ»Ğ¸Ñ‚": Ğ¾Ñ‚ 3000â‚½
ğŸ”¹ "Ğ’ĞµÑ‚ĞœĞ¸Ñ€": Ğ¾Ñ‚ 2500â‚½

ğŸŒŸ <b>Ğ’ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾:</b>
âœ”ï¸ ĞĞ¿ĞµÑ€Ğ°Ñ†Ğ¸Ñ
âœ”ï¸ ĞĞ°Ñ€ĞºĞ¾Ğ·
âœ”ï¸ ĞŸĞ¾ÑĞ»ĞµĞ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ğ¹ ÑƒÑ…Ğ¾Ğ´
âœ”ï¸ ĞšĞ¾Ğ½ÑÑƒĞ»ÑŒÑ‚Ğ°Ñ†Ğ¸Ñ

ğŸ“ <b>Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ:</b>
ğŸ”¹ "ĞĞ¹Ğ±Ğ¾Ğ»Ğ¸Ñ‚": +7 978 000-00-12
ğŸ”¹ "Ğ’ĞµÑ‚ĞœĞ¸Ñ€": +7 978 000-00-13

ğŸ’¡ <b>Ğ¡ĞºĞ¸Ğ´ĞºĞ¸:</b>
ğŸ”¸ Ğ’Ğ¾Ğ»Ğ¾Ğ½Ñ‚ĞµÑ€Ğ°Ğ¼ - 20%
ğŸ”¸ ĞœĞ½Ğ¾Ğ³Ğ¾ĞºĞ²Ğ°Ñ€Ñ‚Ğ¸Ñ€Ğ½Ñ‹Ğ¼ ĞºĞ¾ÑˆĞºĞ°Ğ¼ - 15%""")

    # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ placeholder Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ, ĞµÑĞ»Ğ¸ ĞµĞ³Ğ¾ Ğ½ĞµÑ‚
    if not os.path.exists('assets/images/sterilization.jpg'):
        # Ğ—Ğ´ĞµÑÑŒ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ´ Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ placeholder Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ
        pass

    bot = CatBotWithPhotos()
    bot.run()
