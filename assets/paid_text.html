import os
import telebot
from telebot import types
from flask import Flask, request, jsonify
from datetime import datetime
import time
import logging
import json
import requests
from bs4 import BeautifulSoup
import re
from typing import Dict, List, Optional
from abc import ABC, abstractmethod

# üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

class AnimalPost:
    """–ú–æ–¥–µ–ª—å –ø–æ—Å—Ç–∞ –æ –∂–∏–≤–æ—Ç–Ω–æ–º"""
    def __init__(self, data: Dict):
        self.id = data.get('id', 'unknown')
        self.title = data.get('title', '')
        self.description = data.get('description', '')
        self.date = data.get('date', '–ù–µ–¥–∞–≤–Ω–æ')
        self.timestamp = data.get('timestamp', 0)
        self.url = data.get('url', '')
        self.contact = data.get('contact', '')
        self.photo_url = data.get('photo_url')
        self.video_url = data.get('video_url')
        self.has_media = data.get('has_media', False)
        self.animal_type = data.get('type', 'cats')  # 'cats' or 'dogs'
        self.channel = data.get('channel', '')
        self.channel_url = data.get('channel_url', '')
        self.text = data.get('text', '')

class ChannelConfig:
    """–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–∞–Ω–∞–ª–æ–≤"""
    CHANNELS = {
        'cats': [
            {
                'username': 'cats_yalta',
                'url': 'https://t.me/cats_yalta',
                'type': 'cats',
                'title': '–ö–æ—Ç–∏–∫–∏ –Ø–ª—Ç–∞ (–∫–∞–Ω–∞–ª)'
            },
            {
                'username': 'cats_yalta_group',
                'url': 'https://t.me/cats_yalta_group',
                'type': 'cats', 
                'title': '–ö–æ—Ç–∏–∫–∏ –Ø–ª—Ç–∞ (–≥—Ä—É–ø–ø–∞)'
            }
        ],
        'dogs': [
            {
                'username': 'dogs_yalta',
                'url': 'https://t.me/dogs_yalta',
                'type': 'dogs',
                'title': '–°–æ–±–∞—á–∫–∏ –Ø–ª—Ç–∞ (–∫–∞–Ω–∞–ª)'
            },
            {
                'username': 'dogs_yalta_group',
                'url': 'https://t.me/dogs_yalta_group',
                'type': 'dogs',
                'title': '–°–æ–±–∞—á–∫–∏ –Ø–ª—Ç–∞ (–≥—Ä—É–ø–ø–∞)'
            }
        ]
    }
    
    @classmethod
    def get_channels(cls, animal_type: str) -> List[Dict]:
        """–ü–æ–ª—É—á–∏—Ç—å –∫–∞–Ω–∞–ª—ã –ø–æ —Ç–∏–ø—É –∂–∏–≤–æ—Ç–Ω–æ–≥–æ"""
        return cls.CHANNELS.get(animal_type, [])
    
    @classmethod
    def get_all_channels(cls) -> List[Dict]:
        """–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∫–∞–Ω–∞–ª—ã"""
        all_channels = []
        for channels in cls.CHANNELS.values():
            all_channels.extend(channels)
        return all_channels

class TextProcessor:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–∞ –ø–æ—Å—Ç–æ–≤"""
    
    CAT_KEYWORDS = [
        '–∫–æ—Ç', '–∫–æ—à–∫', '–∫–æ—Ç–µ–Ω', '–∫–æ—Ç–∏–∫', '–º—É—Ä–∑', '–º—è—É',
        '–∫–æ—Ç.', '–∫–æ—à–∫–∞', '–∫–æ—Ç—è—Ç–∞', '–∫–æ—Ç–µ–Ω–æ–∫', '–∫–∏—Å–∞', '–∫–∏—Å–∫–∞'
    ]
    
    DOG_KEYWORDS = [
        '—Å–æ–±–∞', '—Å–æ–±–∞–∫', '—â–µ–Ω', '–ø–µ—Å', '–ø—Å–∏–Ω', '–≥–∞–≤',
        '—â–µ–Ω–æ–∫', '—â–µ–Ω—è—Ç–∞', '—Å–æ–±–∞–∫–∞', '–ø–µ—Å–∏–∫', '–ª–∞–±—Ä', '–æ–≤—á–∞—Ä'
    ]
    
    COMMON_KEYWORDS = [
        '–ø—Ä–∏—Å—Ç—Ä–æ–π', '–¥–æ–º', '–ø–∏—Ç–æ–º–µ—Ü', '—Å—Ç–µ—Ä–∏–ª', '–ø—Ä–∏–≤–∏–≤–∫',
        '–ø–æ—Ç–µ—Ä—è–ª', '–Ω–∞—à–µ–ª', '–ø—Ä–æ–ø–∞–ª', '–Ω–∞–π–¥–µ–Ω', '–ø–æ—Ç–µ—Ä—è—à–∫–∞',
        '–ø—Ä–∏—é—Ç', '–≤–æ–ª–æ–Ω—Ç–µ—Ä', '–ø–æ–º–æ—â—å', '–ª–µ—á–µ–Ω–∏–µ', '–≤–µ—Ç–µ—Ä–∏–Ω–∞—Ä'
    ]
    
    @classmethod
    def extract_title(cls, text: str, animal_type: str = 'cats') -> str:
        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –ø–æ—Å—Ç–∞"""
        lines = text.split('\n')
        for line in lines[:3]:
            line = line.strip()
            if line and len(line) > 5:
                title = re.sub(r'[^\w\s\-\.,!?–∞-—è—ë–ê-–Ø–Å]', '', line)
                if len(title) > 50:
                    title = title[:50] + "..."
                return title or cls._get_default_title(animal_type)
        return cls._get_default_title(animal_type)
    
    @classmethod
    def _get_default_title(cls, animal_type: str) -> str:
        """–ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"""
        return "–ö–æ—Ç–∏–∫ –∏—â–µ—Ç –¥–æ–º" if animal_type == 'cats' else "–°–æ–±–∞—á–∫–∞ –∏—â–µ—Ç –¥–æ–º"
    
    @classmethod
    def extract_description(cls, text: str) -> str:
        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑ —Ç–µ–∫—Å—Ç–∞"""
        clean_text = re.sub(r'@\w+|https?://\S+|\+?\d[\d\s\-\(\)]+', '', text)
        clean_text = re.sub(r'\s+', ' ', clean_text).strip()
        if len(clean_text) > 200:
            return clean_text[:200] + "..."
        return clean_text or "–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ –ø–æ—Å—Ç–µ"
    
    @classmethod
    def extract_contact(cls, text: str) -> str:
        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é"""
        phone_pattern = r'\+?[78][\s\-]?\(?9\d{2}\)?\s?[\d\s\-]{7,10}'
        phones = re.findall(phone_pattern, text)
        
        username_pattern = r'@\w+'
        usernames = re.findall(username_pattern, text)
        
        contacts = []
        if phones:
            contacts.extend(phones[:1])
        if usernames:
            contacts.extend(usernames[:1])
            
        return ' ‚Ä¢ '.join(contacts) if contacts else "–°–º. –≤ –≥—Ä—É–ø–ø–µ"
    
    @classmethod
    def is_animal_related(cls, text: str, animal_type: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –ª–∏ –ø–æ—Å—Ç –∫ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–º—É —Ç–∏–ø—É –∂–∏–≤–æ—Ç–Ω—ã—Ö"""
        text_lower = text.lower()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
        if animal_type == 'cats':
            specific_keywords = cls.CAT_KEYWORDS
        elif animal_type == 'dogs':
            specific_keywords = cls.DOG_KEYWORDS
        else:
            return False
        
        # –î–æ–ª–∂–Ω—ã –±—ã—Ç—å –ª–∏–±–æ —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ —Å–ª–æ–≤–∞, –ª–∏–±–æ –æ–±—â–∏–µ —Å–ª–æ–≤–∞ –æ –∂–∏–≤–æ—Ç–Ω—ã—Ö
        has_specific = any(keyword in text_lower for keyword in specific_keywords)
        has_common = any(keyword in text_lower for keyword in cls.COMMON_KEYWORDS)
        
        return has_specific or has_common

class WebParser:
    """–ü–∞—Ä—Å–µ—Ä –≤–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü Telegram –∫–∞–Ω–∞–ª–æ–≤"""
    
    def __init__(self):
        self.session = requests.Session()
        self.session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
        })
    
    def parse_channel(self, channel: Dict, limit: int = 10) -> List[AnimalPost]:
        """–ü–∞—Ä—Å–∏—Ç –æ–¥–∏–Ω –∫–∞–Ω–∞–ª"""
        try:
            web_url = f'https://t.me/s/{channel["username"]}'
            logger.info(f"üåê –ü–∞—Ä—Å–∏–Ω–≥ {web_url}")
            
            response = self.session.get(web_url, timeout=15)
            response.raise_for_status()
            
            soup = BeautifulSoup(response.content, 'html.parser')
            message_divs = soup.find_all('div', class_='tgme_widget_message')
            
            posts = []
            for div in message_divs[:limit*2]:
                post_data = self._parse_message_div(div, channel)
                if post_data and TextProcessor.is_animal_related(
                    post_data.get('text', ''), channel['type']
                ):
                    posts.append(AnimalPost(post_data))
                    if len(posts) >= limit:
                        break
            
            logger.info(f"‚úÖ {channel['title']}: –Ω–∞–π–¥–µ–Ω–æ {len(posts)} –ø–æ—Å—Ç–æ–≤")
            return posts
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ {channel.get('title', '–∫–∞–Ω–∞–ª–∞')}: {e}")
            return []
    
    def _parse_message_div(self, div, channel) -> Optional[Dict]:
        """–ü–∞—Ä—Å–∏—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø–æ—Å—Ç"""
        try:
            # –ë–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
            post_id = div.get('data-post', '').split('/')[-1] or 'unknown'
            text_div = div.find('div', class_='tgme_widget_message_text')
            text = text_div.get_text(strip=True) if text_div else ""
            
            # –î–∞—Ç–∞
            timestamp = 0
            date_elem = div.find('time', datetime=True)
            date_str = "–ù–µ–¥–∞–≤–Ω–æ"
            if date_elem:
                try:
                    dt = datetime.fromisoformat(date_elem['datetime'].replace('Z', '+00:00'))
                    date_str = dt.strftime('%d.%m.%Y %H:%M')
                    timestamp = dt.timestamp()
                except:
                    pass
            
            # –ú–µ–¥–∏–∞
            photo_url = self._extract_photo_url(div)
            video_url = self._extract_video_url(div)
            
            if not text and not photo_url and not video_url:
                return None
            
            return {
                'id': post_id,
                'text': text,
                'date': date_str,
                'timestamp': timestamp,
                'url': f"{channel['url']}/{post_id}" if post_id != 'unknown' else channel['url'],
                'title': TextProcessor.extract_title(text, channel['type']),
                'description': TextProcessor.extract_description(text),
                'contact': TextProcessor.extract_contact(text),
                'photo_url': photo_url,
                'video_url': video_url,
                'has_media': bool(photo_url or video_url),
                'type': channel['type'],
                'channel': channel['title'],
                'channel_url': channel['url']
            }
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø–æ—Å—Ç–∞: {e}")
            return None
    
    def _extract_photo_url(self, div) -> Optional[str]:
        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç URL —Ñ–æ—Ç–æ"""
        photo_wrap = div.find('a', class_='tgme_widget_message_photo_wrap')
        if photo_wrap and photo_wrap.get('style'):
            match = re.search(r"background-image:url\('(.*?)'\)", photo_wrap['style'])
            if match:
                return match.group(1)
        return None
    
    def _extract_video_url(self, div) -> Optional[str]:
        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç URL –≤–∏–¥–µ–æ"""
        video_wrap = div.find('div', class_='tgme_widget_message_video_wrap')
        if video_wrap and video_wrap.get('style'):
            match = re.search(r"background-image:url\('(.*?)'\)", video_wrap['style'])
            if match:
                return match.group(1)
        return None

class AnimalDataService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏ –æ –∂–∏–≤–æ—Ç–Ω—ã—Ö"""
    
    def __init__(self):
        self.parser = WebParser()
        self.cache = {'cats': [], 'dogs': []}
        self.last_update = {'cats': None, 'dogs': None}
        self.cache_duration = 3600  # 1 —á–∞—Å
    
    def get_posts(self, animal_type: str, limit: int = 5, force_refresh: bool = False) -> List[AnimalPost]:
        """–ü–æ–ª—É—á–∞–µ—Ç –ø–æ—Å—Ç—ã –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ –∂–∏–≤–æ—Ç–Ω—ã—Ö"""
        if self._should_refresh_cache(animal_type) or force_refresh:
            self._refresh_cache(animal_type, limit)
        
        cached_posts = self.cache.get(animal_type, [])
        if cached_posts:
            return cached_posts[:limit]
        
        # –ï—Å–ª–∏ –∫—ç—à –ø—É—Å—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º mock –¥–∞–Ω–Ω—ã–µ
        return self._get_mock_posts(animal_type, limit)
    
    def _should_refresh_cache(self, animal_type: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω—É–∂–Ω–æ –ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å –∫—ç—à"""
        last_update = self.last_update.get(animal_type)
        if not last_update:
            return True
        
        return (datetime.now() - last_update).seconds > self.cache_duration
    
    def _refresh_cache(self, animal_type: str, limit: int = 10):
        """–û–±–Ω–æ–≤–ª—è–µ—Ç –∫—ç—à –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ –∂–∏–≤–æ—Ç–Ω—ã—Ö"""
        try:
            channels = ChannelConfig.get_channels(animal_type)
            all_posts = []
            
            for channel in channels:
                posts = self.parser.parse_channel(channel, limit)
                all_posts.extend(posts)
            
            # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ
            all_posts.sort(key=lambda x: x.timestamp, reverse=True)
            
            self.cache[animal_type] = all_posts[:limit]
            self.last_update[animal_type] = datetime.now()
            
            logger.info(f"‚úÖ –ö—ç—à {animal_type} –æ–±–Ω–æ–≤–ª–µ–Ω: {len(all_posts)} –ø–æ—Å—Ç–æ–≤")
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—ç—à–∞ {animal_type}: {e}")
    
    def _get_mock_posts(self, animal_type: str, limit: int = 2) -> List[AnimalPost]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ –ø–æ—Å—Ç—ã"""
        if animal_type == 'cats':
            mock_data = [
                {
                    'id': '1001',
                    'title': 'üê± –ö–æ—Ç–µ–Ω–æ–∫ –ú—É—Ä–∑–∏–∫ –∏—â–µ—Ç –¥–æ–º',
                    'description': '–í–æ–∑—Ä–∞—Å—Ç: 2 –º–µ—Å—è—Ü–∞, –º–∞–ª—å—á–∏–∫, —Ä—ã–∂–∏–π –æ–∫—Ä–∞—Å. –ó–¥–æ—Ä–æ–≤, –ø—Ä–∏–≤–∏—Ç, –æ—á–µ–Ω—å –∏–≥—Ä–∏–≤—ã–π.',
                    'date': '03.08.2025 14:30',
                    'timestamp': time.time(),
                    'url': 'https://t.me/cats_yalta/1001',
                    'contact': '@volunteer1 ‚Ä¢ +7 978 123-45-67',
                    'photo_url': 'https://via.placeholder.com/600x400?text=–ö–æ—Ç–µ–Ω–æ–∫+–ú—É—Ä–∑–∏–∫',
                    'video_url': None,
                    'has_media': True,
                    'type': 'cats',
                    'channel': '–ö–æ—Ç–∏–∫–∏ –Ø–ª—Ç–∞',
                    'channel_url': 'https://t.me/cats_yalta'
                },
                {
                    'id': '1002',
                    'title': 'üê± –í–∑—Ä–æ—Å–ª—ã–π –∫–æ—Ç –ë–∞—Ä—Å–∏–∫',
                    'description': '–ò—â–µ—Ç –¥–æ–º –≤–∑—Ä–æ—Å–ª—ã–π –∫–æ—Ç, 3 –≥–æ–¥–∞, –∫–∞—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω, –ø—Ä–∏—É—á–µ–Ω –∫ –ª–æ—Ç–∫—É.',
                    'date': '02.08.2025 11:20',
                    'timestamp': time.time() - 3600,
                    'url': 'https://t.me/cats_yalta_group/1002',
                    'contact': '+7 978 765-43-21',
                    'photo_url': 'https://via.placeholder.com/600x400?text=–ö–æ—Ç+–ë–∞—Ä—Å–∏–∫',
                    'video_url': None,
                    'has_media': True,
                    'type': 'cats',
                    'channel': '–ö–æ—Ç–∏–∫–∏ –Ø–ª—Ç–∞ (–≥—Ä—É–ø–ø–∞)',
                    'channel_url': 'https://t.me/cats_yalta_group'
                }
            ]
        else:  # dogs
            mock_data = [
                {
                    'id': '2001',
                    'title': 'üê∂ –©–µ–Ω–æ–∫ –†–µ–∫—Å –∏—â–µ—Ç –¥–æ–º',
                    'description': '–í–æ–∑—Ä–∞—Å—Ç: 3 –º–µ—Å—è—Ü–∞, –º–∞–ª—å—á–∏–∫, –º–µ—Ç–∏—Å. –ó–¥–æ—Ä–æ–≤, –ø—Ä–∏–≤–∏—Ç, –æ—á–µ–Ω—å –∞–∫—Ç–∏–≤–Ω—ã–π.',
                    'date': '03.08.2025 15:30',
                    'timestamp': time.time(),
                    'url': 'https://t.me/dogs_yalta/2001',
                    'contact': '@dog_volunteer ‚Ä¢ +7 978 111-22-33',
                    'photo_url': 'https://via.placeholder.com/600x400?text=–©–µ–Ω–æ–∫+–†–µ–∫—Å',
                    'video_url': None,
                    'has_media': True,
                    'type': 'dogs',
                    'channel': '–°–æ–±–∞—á–∫–∏ –Ø–ª—Ç–∞',
                    'channel_url': 'https://t.me/dogs_yalta'
                },
                {
                    'id': '2002',
                    'title': 'üê∂ –í–∑—Ä–æ—Å–ª–∞—è —Å–æ–±–∞–∫–∞ –õ–∞–π–∫–∞',
                    'description': '–ò—â–µ—Ç –¥–æ–º –≤–∑—Ä–æ—Å–ª–∞—è —Å–æ–±–∞–∫–∞, 2 –≥–æ–¥–∞, —Å—Ç–µ—Ä–∏–ª–∏–∑–æ–≤–∞–Ω–∞, –¥—Ä—É–∂–µ–ª—é–±–Ω–∞—è.',
                    'date': '02.08.2025 10:15',
                    'timestamp': time.time() - 7200,
                    'url': 'https://t.me/dogs_yalta_group/2002',
                    'contact': '+7 978 444-55-66',
                    'photo_url': 'https://via.placeholder.com/600x400?text=–°–æ–±–∞–∫–∞+–õ–∞–π–∫–∞',
                    'video_url': None,
                    'has_media': True,
                    'type': 'dogs',
                    'channel': '–°–æ–±–∞—á–∫–∏ –Ø–ª—Ç–∞ (–≥—Ä—É–ø–ø–∞)',
                    'channel_url': 'https://t.me/dogs_yalta_group'
                }
            ]
        
        return [AnimalPost(data) for data in mock_data[:limit]]

class KeyboardManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä –∫–ª–∞–≤–∏–∞—Ç—É—Ä –±–æ—Ç–∞"""
    
    @staticmethod
    def get_main_keyboard():
        """–ì–ª–∞–≤–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞"""
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=2)
        markup.add("üè• –°—Ç–µ—Ä–∏–ª–∏–∑–∞—Ü–∏—è", "üè† –ü—Ä–∏—Å—Ç—Ä–æ–π—Å—Ç–≤–æ")
        markup.add("üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã", "‚ÑπÔ∏è –û –ø—Ä–æ–µ–∫—Ç–µ")
        return markup
    
    @staticmethod
    def get_adoption_keyboard():
        """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø—Ä–∏—Å—Ç—Ä–æ–π—Å—Ç–≤–∞"""
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=2)
        markup.add("üê± –ö–æ—à–∫–∏ –∏—â—É—Ç –¥–æ–º", "üê∂ –°–æ–±–∞–∫–∏ –∏—â—É—Ç –¥–æ–º")
        markup.add("üìù –ü–æ–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ")
        markup.add("üîô –ù–∞–∑–∞–¥")
        return markup
    
    @staticmethod
    def get_sterilization_keyboard():
        """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å—Ç–µ—Ä–∏–ª–∏–∑–∞—Ü–∏–∏"""
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
        markup.add("üí∞ –ü–ª–∞—Ç–Ω–∞—è —Å—Ç–µ—Ä–∏–ª–∏–∑–∞—Ü–∏—è", "üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è —Å—Ç–µ—Ä–∏–ª–∏–∑–∞—Ü–∏—è")
        markup.add("üîô –ù–∞–∑–∞–¥")
        return markup

class MessageSender:
    """–û—Ç–ø—Ä–∞–≤—â–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π"""
    
    def __init__(self, bot: telebot.TeleBot):
        self.bot = bot
    
    def send_animal_post(self, chat_id: int, post: AnimalPost):
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ—Å—Ç –æ –∂–∏–≤–æ—Ç–Ω–æ–º"""
        try:
            emoji = 'üê±' if post.animal_type == 'cats' else 'üê∂'
            post_text = (
                f"{emoji} <b>{post.title}</b>\n\n"
                f"{post.description}\n\n"
                f"üìÖ {post.date}\n"
                f"üìû {post.contact}\n"
                f"üì¢ <a href='{post.channel_url}'>{post.channel}</a>\n"
                f"üîó <a href='{post.url}'>–û—Ç–∫—Ä—ã—Ç—å –ø–æ—Å—Ç</a>"
            )
            
            if len(post_text) > 1024:
                post_text = post_text[:1000] + "..."
            
            # –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –º–µ–¥–∏–∞
            if post.photo_url:
                try:
                    self.bot.send_photo(
                        chat_id,
                        post.photo_url,
                        caption=post_text,
                        parse_mode="HTML",
                        reply_markup=types.InlineKeyboardMarkup().add(
                            types.InlineKeyboardButton("üì¢ –û—Ç–∫—Ä—ã—Ç—å –ø–æ—Å—Ç", url=post.url)
                        )
                    )
                    return
                except Exception as e:
                    logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ: {e}")
            
            if post.video_url:
                try:
                    self.bot.send_video(
                        chat_id,
                        post.video_url,
                        caption=post_text,
                        parse_mode="HTML",
                        reply_markup=types.InlineKeyboardMarkup().add(
                            types.InlineKeyboardButton("üì¢ –û—Ç–∫—Ä—ã—Ç—å –ø–æ—Å—Ç", url=post.url)
                        )
                    )
                    return
                except Exception as e:
                    logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤–∏–¥–µ–æ: {e}")
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            self.bot.send_message(
                chat_id,
                post_text,
                parse_mode="HTML",
                disable_web_page_preview=False,
                reply_markup=types.InlineKeyboardMarkup().add(
                    types.InlineKeyboardButton("üì¢ –û—Ç–∫—Ä—ã—Ç—å –ø–æ—Å—Ç", url=post.url)
                )
            )
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ—Å—Ç–∞: {e}")
    
    def send_animal_posts_list(self, chat_id: int, animal_type: str, posts: List[AnimalPost]):
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–ø–∏—Å–æ–∫ –ø–æ—Å—Ç–æ–≤ –æ –∂–∏–≤–æ—Ç–Ω—ã—Ö"""
        try:
            if not posts:
                animal_name = "–∫–æ—à–µ–∫" if animal_type == 'cats' else "—Å–æ–±–∞–∫"
                channels = ChannelConfig.get_channels(animal_type)
                channel_links = "\n".join([f"‚Ä¢ {ch['url']}" for ch in channels])
                
                self.bot.send_message(
                    chat_id,
                    f"üòø –°–µ–π—á–∞—Å –Ω–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π –æ {animal_name}.\n\n"
                    f"üì¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≥—Ä—É–ø–ø—ã:\n{channel_links}"
                )
                return
            
            # –ó–∞–≥–æ–ª–æ–≤–æ–∫
            if animal_type == 'cats':
                title = "üê± <b>–ö–û–¢–ò–ö–ò –ò–©–£–¢ –î–û–ú</b>"
                help_text = "üè† <b>–í–∑—è—Ç—å –∫–æ—Ç–∏–∫–∞:</b>\n–°–≤—è–∂–∏—Ç–µ—Å—å –ø–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º –∏–∑ –æ–±—ä—è–≤–ª–µ–Ω–∏—è"
            else:
                title = "üê∂ <b>–°–û–ë–ê–ß–ö–ò –ò–©–£–¢ –î–û–ú</b>" 
                help_text = "üè† <b>–í–∑—è—Ç—å —Å–æ–±–∞—á–∫—É:</b>\n–°–≤—è–∂–∏—Ç–µ—Å—å –ø–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º –∏–∑ –æ–±—ä—è–≤–ª–µ–Ω–∏—è"
            
            self.bot.send_message(
                chat_id,
                f"{title}\n\nüì¢ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –∏–∑ –≥—Ä—É–ø–ø –Ø–ª—Ç—ã:",
                parse_mode="HTML"
            )
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ—Å—Ç—ã
            for post in posts:
                self.send_animal_post(chat_id, post)
                time.sleep(0.7)  # –ó–∞—â–∏—Ç–∞ –æ—Ç —Ñ–ª—É–¥–∞
            
            # –°–ø—Ä–∞–≤–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            channels = ChannelConfig.get_channels(animal_type)
            channel_links = "\n".join([
                f"‚Ä¢ <a href='{ch['url']}'>{ch['title']}</a>" for ch in channels
            ])
            
            self.bot.send_message(
                chat_id,
                f"üí° <b>–ö–∞–∫ –ø–æ–º–æ—á—å?</b>\n\n"
                f"{help_text}\n\n"
                f"üì¢ <b>–ì—Ä—É–ø–ø—ã:</b>\n{channel_links}\n\n"
                "ü§ù <b>–°—Ç–∞—Ç—å –≤–æ–ª–æ–Ω—Ç–µ—Ä–æ–º:</b>\n–ù–∞–ø–∏—à–∏—Ç–µ –≤ –≥—Ä—É–ø–ø—É",
                parse_mode="HTML"
            )
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–ø–∏—Å–∫–∞ –ø–æ—Å—Ç–æ–≤: {e}")
            channels = ChannelConfig.get_channels(animal_type)
            channel_links = "\n".join([f"‚Ä¢ {ch['url']}" for ch in channels])
            
            self.bot.send_message(
                chat_id,
                f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏–π\n\n"
                f"–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –ø–æ—Å–µ—Ç–∏—Ç–µ –≥—Ä—É–ø–ø—ã:\n{channel_links}"
            )

class FileManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä —Ñ–∞–π–ª–æ–≤"""
    
    @staticmethod
    def load_html_file(filename: str) -> str:
        """–ó–∞–≥—Ä—É–∂–∞–µ—Ç HTML —Ñ–∞–π–ª –∏–∑ –ø–∞–ø–∫–∏ assets"""
        try:
            with open(f'assets/{filename}', 'r', encoding='utf-8') as f:
                return f.read()
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ HTML: {e}")
            return f"‚ö†Ô∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ ({filename})"
    
    @staticmethod
    def setup_assets_files():
        """–°–æ–∑–¥–∞–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ–∞–π–ª—ã –∏ –ø–∞–ø–∫–∏"""
        os.makedirs('assets/images', exist_ok=True)
        
        # –§–∞–π–ª —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π —Å—Ç–µ—Ä–∏–ª–∏–∑–∞—Ü–∏–∏
        if not os.path.exists('assets/free_text.html'):
            with open('assets/free_text.html', 'w', encoding='utf-8') as f:
                f.write("""<b>üêæ –ë–ï–°–ü–õ–ê–¢–ù–ê–Ø –°–¢–ï–†–ò–õ–ò–ó–ê–¶–ò–Ø</b>

üè• <b>–ü—Ä–æ–≥—Ä–∞–º–º—ã:</b>
üîπ –ú—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ –Ø–ª—Ç—ã
üîπ –ë–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–æ–Ω–¥—ã

üìã <b>–£—Å–ª–æ–≤–∏—è:</b>
‚úÖ –ë–µ–∑–¥–æ–º–Ω—ã–µ –∫–æ—à–∫–∏/—Å–æ–±–∞–∫–∏
‚úÖ –ñ–∏–≤–æ—Ç–Ω—ã–µ –∏–∑ –º–∞–ª–æ–∏–º—É—â–∏—Ö —Å–µ–º–µ–π
‚úÖ –ü–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é –≤–æ–ª–æ–Ω—Ç–µ—Ä–æ–≤

üìû <b>–ö–æ–Ω—Ç–∞–∫—Ç—ã:</b>
üîπ –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä: +7 978 144-90-70
üîπ –ö–ª–∏–Ω–∏–∫–∞ "–ê–π–±–æ–ª–∏—Ç": +7 978 000-00-11

üìç <b>–ê–¥—Ä–µ—Å–∞:</b>
—É–ª. –ö–∏—Ä–æ–≤–∞, 15 (–ø–Ω-–ø—Ç 9:00-18:00)""")

        # –§–∞–π–ª —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–ª–∞—Ç–Ω–æ–π —Å—Ç–µ—Ä–∏–ª–∏–∑–∞—Ü–∏–∏
        if not os.path.exists('assets/paid_text.html'):
            with open('assets/paid_text.html', 'w', encoding='utf-8') as f:
                f.write("""<b>üíµ –ü–õ–ê–¢–ù–ê–Ø –°–¢–ï–†–ò–õ–ò–ó–ê–¶–ò–Ø</b>

üè• <b>–ö–ª–∏–Ω–∏–∫–∏:</b>
üîπ "–ê–π–±–æ–ª–∏—Ç": –æ—Ç 3000‚ÇΩ
üîπ "–í–µ—Ç–ú–∏—Ä": –æ—Ç 2500‚ÇΩ

üåü <b>–í–∫–ª—é—á–µ–Ω–æ:</b>
‚úîÔ∏è –û–ø–µ—Ä–∞—Ü–∏—è
‚úîÔ∏è –ù–∞—Ä–∫–æ–∑
‚úîÔ∏è –ü–æ—Å–ª–µ–æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —É—Ö–æ–¥
‚úîÔ∏è –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è

üìû <b>–ó–∞–ø–∏—Å—å:</b>
üîπ "–ê–π–±–æ–ª–∏—Ç": +7 978 000-00-12
üîπ "–í–µ—Ç–ú–∏—Ä": +7 978 000-00-13

üí° <b>–°–∫–∏–¥–∫–∏:</b>
üî∏ –í–æ–ª–æ–Ω—Ç–µ—Ä–∞–º - 20%
üî∏ –ü—Ä–∏ —Å—Ç–µ—Ä–∏–ª–∏–∑–∞—Ü–∏–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∂–∏–≤–æ—Ç–Ω—ã—Ö - 15%""")

class CatDogBot:
    """–û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å –±–æ—Ç–∞ –¥–ª—è –ø–æ–º–æ—â–∏ –∂–∏–≤–æ—Ç–Ω—ã–º –Ø–ª—Ç—ã"""
    
    def __init__(self):
        self.token = os.environ.get('TOKEN')
        if not self.token:
            logger.error("‚ùå TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω!")
            exit(1)
        
        self.bot = telebot.TeleBot(self.token)
        self.data_service = AnimalDataService()
        self.message_sender = MessageSender(self.bot)
        self.keyboard_manager = KeyboardManager()
        self.file_manager = FileManager()
        
        self.app = Flask(__name__)
        self.port = int(os.environ.get('PORT', 8080))
        self.webhook_url = os.environ.get('WEBHOOK_URL')
        self.stats = {"users": set(), "messages": 0}
        
        self.setup_handlers()
        self.setup_routes()
    
    def setup_handlers(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π"""
        
        @self.bot.message_handler(commands=['start'])
        def start_handler(message):
            self.stats["users"].add(message.from_user.id)
            self.stats["messages"] += 1
            
            welcome_text = """üëã <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ "–ñ–∏–≤–æ—Ç–Ω—ã–µ –Ø–ª—Ç—ã"!</b>

üêæ –ü–æ–º–æ—â–Ω–∏–∫ –ø–æ –∫–æ—à–∫–∞–º –∏ —Å–æ–±–∞–∫–∞–º –Ø–ª—Ç—ã

–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:
üè• <b>–°—Ç–µ—Ä–∏–ª–∏–∑–∞—Ü–∏—è</b> - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç–µ—Ä–∏–ª–∏–∑–∞—Ü–∏–∏
üè† <b>–ü—Ä–∏—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</b> - –∂–∏–≤–æ—Ç–Ω—ã–µ –∏—â—É—Ç –¥–æ–º
üìû <b>–ö–æ–Ω—Ç–∞–∫—Ç—ã</b> - —Å–≤—è–∑—å —Å –≤–æ–ª–æ–Ω—Ç–µ—Ä–∞–º–∏
‚ÑπÔ∏è <b>–û –ø—Ä–æ–µ–∫—Ç–µ</b> - –Ω–∞—à–∞ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å"""
            
            self.bot.send_message(
                message.chat.id, 
                welcome_text, 
                parse_mode="HTML",
                reply_markup=self.keyboard_manager.get_main_keyboard()
            )
        
        @self.bot.message_handler(commands=['update'])
        def update_handler(message):
            """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–æ–≤ (–¥–ª—è –∞–¥–º–∏–Ω–æ–≤)"""
            admin_ids = [123456789]  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
            if message.from_user.id not in admin_ids:
                return
                
            self.bot.send_message(message.chat.id, "üîÑ –û–±–Ω–æ–≤–ª—è—é –ø–æ—Å—Ç—ã...")
            
            # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à
            cats_posts = self.data_service.get_posts('cats', force_refresh=True)
            dogs_posts = self.data_service.get_posts('dogs', force_refresh=True)
            
            self.bot.send_message(
                message.chat.id, 
                f"‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ:\n"
                f"üê± –ö–æ—à–∫–∏: {len(cats_posts)} –ø–æ—Å—Ç–æ–≤\n"
                f"üê∂ –°–æ–±–∞–∫–∏: {len(dogs_posts)} –ø–æ—Å—Ç–æ–≤"
            )
        
        # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å—Ç–µ—Ä–∏–ª–∏–∑–∞—Ü–∏–∏
        @self.bot.message_handler(func=lambda m: m.text == "üè• –°—Ç–µ—Ä–∏–ª–∏–∑–∞—Ü–∏—è")
        def sterilization_handler(message):
            self.stats["users"].add(message.from_user.id)
            self.stats["messages"] += 1
            
            try:
                with open('assets/images/sterilization.jpg', 'rb') as photo:
                    self.bot.send_photo(
                        message.chat.id,
                        photo,
                        caption="üè• <b>–°—Ç–µ—Ä–∏–ª–∏–∑–∞—Ü–∏—è –∂–∏–≤–æ—Ç–Ω—ã—Ö</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç:",
                        parse_mode="HTML",
                        reply_markup=self.keyboard_manager.get_sterilization_keyboard()
                    )
            except Exception as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ: {e}")
                self.bot.send_message(
                    message.chat.id,
                    "üè• <b>–°—Ç–µ—Ä–∏–ª–∏–∑–∞—Ü–∏—è –∂–∏–≤–æ—Ç–Ω—ã—Ö</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç:",
                    parse_mode="HTML",
                    reply_markup=self.keyboard_manager.get_sterilization_keyboard()
                )
        
        @self.bot.message_handler(func=lambda m: m.text == "üí∞ –ü–ª–∞—Ç–Ω–∞—è —Å—Ç–µ—Ä–∏–ª–∏–∑–∞—Ü–∏—è")
        def paid_sterilization_handler(message):
            self.bot.send_message(
                message.chat.id,
                self.file_manager.load_html_file('paid_text.html'),
                parse_mode="HTML"
            )
        
        @self.bot.message_handler(func=lambda m: m.text == "üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è —Å—Ç–µ—Ä–∏–ª–∏–∑–∞—Ü–∏—è")
        def free_sterilization_handler(message):
            self.bot.send_message(
                message.chat.id,
                self.file_manager.load_html_file('free_text.html'),
                parse_mode="HTML"
            )
        
        # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø—Ä–∏—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        @self.bot.message_handler(func=lambda m: m.text == "üè† –ü—Ä–∏—Å—Ç—Ä–æ–π—Å—Ç–≤–æ")
        def adoption_handler(message):
            self.stats["users"].add(message.from_user.id)
            self.stats["messages"] += 1
            
            info_text = """üè† <b>–ü—Ä–∏—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∂–∏–≤–æ—Ç–Ω—ã—Ö</b>

–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:

üê± <b>–ö–æ—à–∫–∏ –∏—â—É—Ç –¥–æ–º</b>
–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –æ –∫–æ—à–∫–∞—Ö

üê∂ <b>–°–æ–±–∞–∫–∏ –∏—â—É—Ç –¥–æ–º</b>
–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –æ —Å–æ–±–∞–∫–∞—Ö

üìù <b>–ü–æ–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</b>
–ö–∞–∫ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å —Å–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ"""
            
            self.bot.send_message(
                message.chat.id, 
                info_text, 
                parse_mode="HTML",
                reply_markup=self.keyboard_manager.get_adoption_keyboard()
            )
        
        @self.bot.message_handler(func=lambda m: m.text == "üê± –ö–æ—à–∫–∏ –∏—â—É—Ç –¥–æ–º")
        def cats_handler(message):
            self.stats["users"].add(message.from_user.id)
            self.stats["messages"] += 1
            
            posts = self.data_service.get_posts('cats', limit=5)
            self.message_sender.send_animal_posts_list(message.chat.id, 'cats', posts)
        
        @self.bot.message_handler(func=lambda m: m.text == "üê∂ –°–æ–±–∞–∫–∏ –∏—â—É—Ç –¥–æ–º")
        def dogs_handler(message):
            self.stats["users"].add(message.from_user.id)
            self.stats["messages"] += 1
            
            posts = self.data_service.get_posts('dogs', limit=5)
            self.message_sender.send_animal_posts_list(message.chat.id, 'dogs', posts)
        
        @self.bot.message_handler(func=lambda m: m.text == "üìù –ü–æ–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ")
        def submit_ad_handler(message):
            cats_channels = ChannelConfig.get_channels('cats')
            dogs_channels = ChannelConfig.get_channels('dogs')
            
            cats_links = "\n".join([f"‚Ä¢ <a href='{ch['url']}'>{ch['title']}</a>" for ch in cats_channels])
            dogs_links = "\n".join([f"‚Ä¢ <a href='{ch['url']}'>{ch['title']}</a>" for ch in dogs_channels])
            
            info_text = f"""üìù <b>–ü–æ–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</b>

üì¢ <b>–ì—Ä—É–ø–ø—ã –¥–ª—è –∫–æ—à–µ–∫:</b>
{cats_links}

üì¢ <b>–ì—Ä—É–ø–ø—ã –¥–ª—è —Å–æ–±–∞–∫:</b>
{dogs_links}

‚úçÔ∏è <b>–ö–∞–∫ –ø–æ–¥–∞—Ç—å:</b>
1Ô∏è‚É£ –ü–µ—Ä–µ–π—Ç–∏ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –≥—Ä—É–ø–ø—É
2Ô∏è‚É£ –ù–∞–ø–∏—Å–∞—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º
3Ô∏è‚É£ –ò–ª–∏ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä–æ–º: +7 978 144-90-70

üìã <b>–ù—É–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</b>
üîπ –§–æ—Ç–æ –∂–∏–≤–æ—Ç–Ω–æ–≥–æ
üîπ –í–æ–∑—Ä–∞—Å—Ç, –ø–æ–ª, –æ–∫—Ä–∞—Å
üîπ –•–∞—Ä–∞–∫—Ç–µ—Ä –∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
üîπ –ó–¥–æ—Ä–æ–≤—å–µ (–ø—Ä–∏–≤–∏–≤–∫–∏, —Å—Ç–µ—Ä–∏–ª–∏–∑–∞—Ü–∏—è)
üîπ –í–∞—à–∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã"""
            
            self.bot.send_message(message.chat.id, info_text, parse_mode="HTML")
        
        # –î—Ä—É–≥–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        @self.bot.message_handler(func=lambda m: m.text == "üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã")
        def contacts_handler(message):
            contacts_text = """üìû <b>–ö–û–ù–¢–ê–ö–¢–´</b>

üë• <b>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä—ã:</b>
üîπ –ü–æ –∫–æ—à–∫–∞–º: +7 978 144-90-70
üîπ –ü–æ —Å–æ–±–∞–∫–∞–º: +7 978 144-90-71
üîπ –ü–æ —Å—Ç–µ—Ä–∏–ª–∏–∑–∞—Ü–∏–∏: +7 978 144-90-72
üîπ –õ–µ—á–µ–Ω–∏–µ: +7 978 144-90-73

üè• <b>–ö–ª–∏–Ω–∏–∫–∏:</b>
üîπ "–ê–π–±–æ–ª–∏—Ç": +7 978 000-00-04
üîπ "–í–µ—Ç–ú–∏—Ä": +7 978 000-00-05

üì± <b>–°–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏:</b>
üîπ Telegram –∫–æ—à–∫–∏: @cats_yalta
üîπ Telegram —Å–æ–±–∞–∫–∏: @dogs_yalta"""
            
            self.bot.send_message(message.chat.id, contacts_text, parse_mode="HTML")
        
        @self.bot.message_handler(func=lambda m: m.text == "‚ÑπÔ∏è –û –ø—Ä–æ–µ–∫—Ç–µ")
        def about_handler(message):
            about_text = """‚ÑπÔ∏è <b>–û –ü–†–û–ï–ö–¢–ï "–ñ–ò–í–û–¢–ù–´–ï –Ø–õ–¢–´"</b>

üéØ <b>–ú–∏—Å—Å–∏—è:</b>
–ü–æ–º–æ—â—å –±–µ–∑–¥–æ–º–Ω—ã–º –∂–∏–≤–æ—Ç–Ω—ã–º –Ø–ª—Ç—ã

üìä <b>–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è:</b>
üîπ –°—Ç–µ—Ä–∏–ª–∏–∑–æ–≤–∞–Ω–æ: 800+ –∂–∏–≤–æ—Ç–Ω—ã—Ö
üîπ –ü—Ä–∏—Å—Ç—Ä–æ–µ–Ω–æ: 500+ –ø–∏—Ç–æ–º—Ü–µ–≤
üîπ –í–æ–ª–æ–Ω—Ç–µ—Ä–æ–≤: 50+ –∞–∫—Ç–∏–≤–Ω—ã—Ö

üê± <b>–ö–æ—à–∫–∏:</b>
‚Ä¢ –°—Ç–µ—Ä–∏–ª–∏–∑–∞—Ü–∏—è –∏ –ª–µ—á–µ–Ω–∏–µ
‚Ä¢ –ü–æ–∏—Å–∫ –¥–æ–º–∞ –¥–ª—è –∫–æ—Ç—è—Ç
‚Ä¢ –£—Ö–æ–¥ –∑–∞ –±–µ–∑–¥–æ–º–Ω—ã–º–∏

üê∂ <b>–°–æ–±–∞–∫–∏:</b>
‚Ä¢ –°—Ç–µ—Ä–∏–ª–∏–∑–∞—Ü–∏—è –∫—Ä—É–ø–Ω—ã—Ö –∂–∏–≤–æ—Ç–Ω—ã—Ö
‚Ä¢ –ü—Ä–∏—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —â–µ–Ω–∫–æ–≤
‚Ä¢ –ü–æ–º–æ—â—å –≤–ª–∞–¥–µ–ª—å—Ü–∞–º

üí∞ <b>–ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å:</b>
–ö–∞—Ä—Ç–∞: 2202 2020 0000 0000

ü§ù <b>–°—Ç–∞—Ç—å –≤–æ–ª–æ–Ω—Ç–µ—Ä–æ–º:</b>
–ü–∏—à–∏—Ç–µ @animal_coordinator"""
            
            self.bot.send_message(message.chat.id, about_text, parse_mode="HTML")
        
        @self.bot.message_handler(func=lambda m: m.text == "üîô –ù–∞–∑–∞–¥")
        def back_handler(message):
            self.bot.send_message(
                message.chat.id, 
                "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:", 
                reply_markup=self.keyboard_manager.get_main_keyboard()
            )
        
        # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        @self.bot.message_handler(func=lambda m: True)
        def default_handler(message):
            self.stats["users"].add(message.from_user.id)
            self.stats["messages"] += 1
            
            self.bot.send_message(
                message.chat.id,
                "‚ùì –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é\n\n/start - –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
                reply_markup=self.keyboard_manager.get_main_keyboard()
            )
    
    def setup_routes(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Flask –º–∞—Ä—à—Ä—É—Ç–æ–≤"""
        
        @self.app.route(f'/{self.token}', methods=['POST'])
        def webhook():
            try:
                if request.headers.get('content-type') == 'application/json':
                    json_string = request.get_data().decode('utf-8')
                    update = telebot.types.Update.de_json(json_string)
                    self.bot.process_new_updates([update])
                    return '', 200
                return 'Bad request', 400
            except Exception as e:
                logger.error(f"‚ùå Webhook –æ—à–∏–±–∫–∞: {e}")
                return 'Internal error', 500
        
        @self.app.route('/')
        def home():
            return jsonify({
                "status": "ü§ñ Animal Bot Running",
                "time": datetime.now().strftime('%H:%M:%S'),
                "users": len(self.stats["users"]),
                "messages": self.stats["messages"],
                "channels": {
                    "cats": [c['url'] for c in ChannelConfig.get_channels('cats')],
                    "dogs": [c['url'] for c in ChannelConfig.get_channels('dogs')]
                },
                "cache_status": {
                    "cats": {
                        "posts": len(self.data_service.cache.get('cats', [])),
                        "last_update": self.data_service.last_update['cats'].isoformat() if self.data_service.last_update['cats'] else None
                    },
                    "dogs": {
                        "posts": len(self.data_service.cache.get('dogs', [])),
                        "last_update": self.data_service.last_update['dogs'].isoformat() if self.data_service.last_update['dogs'] else None
                    }
                }
            })
        
        @self.app.route('/posts/<animal_type>')
        def posts_api(animal_type):
            try:
                if animal_type not in ['cats', 'dogs']:
                    return jsonify({"status": "error", "message": "Invalid animal type"}), 400
                
                posts = self.data_service.get_posts(animal_type)
                return jsonify({
                    "status": "ok",
                    "animal_type": animal_type,
                    "count": len(posts),
                    "posts": [{
                        "title": p.title,
                        "url": p.url,
                        "date": p.date,
                        "channel": p.channel,
                        "has_media": p.has_media
                    } for p in posts],
                    "channels": [c['url'] for c in ChannelConfig.get_channels(animal_type)]
                })
            except Exception as e:
                return jsonify({"status": "error", "message": str(e)}), 500
        
        @self.app.route('/refresh/<animal_type>', methods=['POST'])
        def refresh_cache(animal_type):
            try:
                if animal_type not in ['cats', 'dogs']:
                    return jsonify({"status": "error", "message": "Invalid animal type"}), 400
                
                posts = self.data_service.get_posts(animal_type, force_refresh=True)
                return jsonify({
                    "status": "ok",
                    "animal_type": animal_type,
                    "refreshed_posts": len(posts),
                    "timestamp": datetime.now().isoformat()
                })
            except Exception as e:
                return jsonify({"status": "error", "message": str(e)}), 500
    
    def setup_webhook(self) -> bool:
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ webhook"""
        try:
            self.bot.remove_webhook()
            time.sleep(2)
            
            if not self.webhook_url:
                logger.error("‚ùå WEBHOOK_URL –Ω–µ –∑–∞–¥–∞–Ω!")
                return False
            
            full_url = f"https://{self.webhook_url}/{self.token}"
            result = self.bot.set_webhook(url=full_url)
            
            if result:
                logger.info(f"‚úÖ Webhook: {full_url}")
                return True
            else:
                logger.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å webhook")
                return False
                
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ webhook: {e}")
            return False
    
    def run(self):
        """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"""
        logger.info("üöÄ –ó–∞–ø—É—Å–∫ Animal Bot –¥–ª—è –Ø–ª—Ç—ã...")
        
        # –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤
        try:
            cats_posts = self.data_service.get_posts('cats')
            dogs_posts = self.data_service.get_posts('dogs')
            logger.info(f"‚úÖ –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–µ–Ω–æ: üê±{len(cats_posts)} –∫–æ—à–µ–∫, üê∂{len(dogs_posts)} —Å–æ–±–∞–∫")
        except Exception as e:
            logger.warning(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∏: {e}")
        
        if self.setup_webhook():
            logger.info(f"üåê –ó–∞–ø—É—Å–∫ Flask —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –ø–æ—Ä—Ç—É {self.port}")
            self.app.run(host='0.0.0.0', port=self.port)
        else:
            logger.error("üö® –û—à–∏–±–∫–∞ webhook, –∑–∞–ø—É—Å–∫ –≤ polling —Ä–µ–∂–∏–º–µ")
            self.bot.polling()

def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞"""
    try:
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∞–π–ª–æ–≤ –∏ –ø–∞–ø–æ–∫
        FileManager.setup_assets_files()
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –∏ –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞
        bot = CatDogBot()
        bot.run()
        
    except KeyboardInterrupt:
        logger.info("üõë –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
    except Exception as e:
        logger.error(f"üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        raise

if __name__ == "__main__":
    main()
